System.register([],(function(t,e){"use strict";return{execute:function(){var e=document.createElement("style");e.textContent="@font-face{font-family:minecraftia;src:url(/assets/minecraftia-Cp293fOh.ttf)}body{height:100%;font-family:minecraftia;font-size:16px;text-shadow:#3f3f3f 2px 2px 0px;background:url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAl5JREFUeNrs3btOw0AQBdDUNBFChMICiRSU/P/fhZbKIzS+GQefYsp9+rgZ7c6evj/fbmvxtby04uP13Iq9z+9yflqN9Pq77U8AAAAAAAAAAAAAAAAAAAAAHApA1UG1gekNqMa/Xq+r0Z1fF2B6/dX6qgAAAAAAAAAAAAAAAAAAAADgWAC6iYZuoiQ9fjrRkt6f9P4BAAAAAAAAAAAAAAAAAAAAcCwAVaJhWZbV6E4gnWiaPlDSbZ9ORAEAAAAAAAAAAAAAAAAAAAAAwJYLrBZQfeC9H7io+q9+oOn5AQAAAAAAAAAAAAAAAAAAAHAsAN0DC9OJlO6BivTFlnT/8QIRAAAAAAAAAAAAAAAAAAAAAPwrAN1ETXeCVYGH9AakCzGmD8x02wMAAAAAAAAAAAAAAAAAAAAAwD03YPrBh26iae/zBwAAAAAAAAAAAAAAAAAAAACA3wCmJ5hu301kTX/g9PoAAAAAAAAAAAAAAAAAAAAAAOAvMX2xYvrixd4PrLQTQQAAAAAAAAAAAAAAAAAAAAAAsOGDB+kDKV3A0x+oiu7FGgAAAAAAAAAAAAAAAAAAAAAA2NPFhfQGVw86pH+Q9IMZVf8AAAAAAAAAAAAAAAAAAAAAHAvA9ASngTx6dBNVAAAAAAAAAAAAAAAAAAAAAACwZYGGKt4vz6sxXcChe2Cke3ElXWgTAAAAAAAAAAAAAAAAAAAAgGMBmN6gdCHE6QIS6fEBAAAAAAAAAAAAAAAAAAAAAOCeAKYfhqwKJHTH3/vFmfGbQQAAAAAAAAAAAAAAAAAAAAA8EoCfAQBi7VZP36fViQAAAABJRU5ErkJggg==)}#renderSurface{position:absolute;left:0;top:0;width:100%;height:100%}#materialSelector{position:relative;margin:auto;background:rgba(0,0,0,.6)}#materialSelector tr{height:70px}#materialSelector td{width:70px;margin:0;padding:0;cursor:pointer;opacity:.3;background:url(/assets/blockthumbs-knI0vhZG.png);background-position:0px 0px}#materialSelector td:hover{opacity:.8}#nickname{position:absolute;top:40%;left:42%;width:300px;cursor:default;color:#fff}#nickname input{width:100%;background:none;border:none;border-bottom:1px solid #888;outline:none;color:#fff;font-family:minecraftia;font-size:24px}#joininfo{position:absolute;top:42%;width:99%;cursor:default;text-align:center;color:#fff;font-size:24px}#chatbox{position:absolute;left:20px;bottom:55px;width:600px;height:195px;overflow:hidden;padding-left:10px;padding-right:10px;cursor:default;background:rgba(0,0,0,.6);color:#fff}#chatbox_text{position:absolute;bottom:8px;text-shadow:none}#chatbox_entry{position:absolute;left:20px;bottom:18px;width:610px;height:30px;padding-left:10px;padding-bottom:2px;background:rgba(0,0,0,.6);border:none;outline:none;color:#fff;font-family:minecraftia;font-size:16px}\n/*$vite$:1*/",document.head.appendChild(e);const s=1e-6,r=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class i extends Float32Array{static BYTE_LENGTH=(()=>16*Float32Array.BYTES_PER_ELEMENT)();constructor(...t){switch(t.length){case 16:super(t);break;case 2:super(t[0],t[1],16);break;case 1:const e=t[0];"number"==typeof e?super([e,e,e,e,e,e,e,e,e,e,e,e,e,e,e,e]):super(e,0,16);break;default:super(r)}}get str(){return i.str(this)}copy(t){return this.set(t),this}identity(){return this.set(r),this}multiply(t){return i.multiply(this,this,t)}mul(t){return this}transpose(){return i.transpose(this,this)}invert(){return i.invert(this,this)}translate(t){return i.translate(this,this,t)}rotate(t,e){return i.rotate(this,this,t,e)}scale(t){return i.scale(this,this,t)}rotateX(t){return i.rotateX(this,this,t)}rotateY(t){return i.rotateY(this,this,t)}rotateZ(t){return i.rotateZ(this,this,t)}perspectiveNO(t,e,s,r){return i.perspectiveNO(this,t,e,s,r)}perspectiveZO(t,e,s,r){return i.perspectiveZO(this,t,e,s,r)}orthoNO(t,e,s,r,n,o){return i.orthoNO(this,t,e,s,r,n,o)}orthoZO(t,e,s,r,n,o){return i.orthoZO(this,t,e,s,r,n,o)}static create(){return new i}static clone(t){return new i(t)}static copy(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}static fromValues(...t){return new i(...t)}static set(t,...e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}static identity(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static transpose(t,e){if(t===e){const s=e[1],r=e[2],i=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=s,t[6]=e[9],t[7]=e[13],t[8]=r,t[9]=n,t[11]=e[14],t[12]=i,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}static invert(t,e){const s=e[0],r=e[1],i=e[2],n=e[3],o=e[4],a=e[5],h=e[6],c=e[7],l=e[8],u=e[9],d=e[10],p=e[11],f=e[12],y=e[13],g=e[14],m=e[15],A=s*a-r*o,b=s*h-i*o,x=s*c-n*o,w=r*h-i*a,v=r*c-n*a,M=i*c-n*h,k=l*y-u*f,T=l*g-d*f,E=l*m-p*f,R=u*g-d*y,_=u*m-p*y,B=d*m-p*g;let P=A*B-b*_+x*R+w*E-v*T+M*k;return P?(P=1/P,t[0]=(a*B-h*_+c*R)*P,t[1]=(i*_-r*B-n*R)*P,t[2]=(y*M-g*v+m*w)*P,t[3]=(d*v-u*M-p*w)*P,t[4]=(h*E-o*B-c*T)*P,t[5]=(s*B-i*E+n*T)*P,t[6]=(g*x-f*M-m*b)*P,t[7]=(l*M-d*x+p*b)*P,t[8]=(o*_-a*E+c*k)*P,t[9]=(r*E-s*_-n*k)*P,t[10]=(f*v-y*x+m*A)*P,t[11]=(u*x-l*v-p*A)*P,t[12]=(a*T-o*R-h*k)*P,t[13]=(s*R-r*T+i*k)*P,t[14]=(y*b-f*w-g*A)*P,t[15]=(l*w-u*b+d*A)*P,t):null}static adjoint(t,e){const s=e[0],r=e[1],i=e[2],n=e[3],o=e[4],a=e[5],h=e[6],c=e[7],l=e[8],u=e[9],d=e[10],p=e[11],f=e[12],y=e[13],g=e[14],m=e[15],A=s*a-r*o,b=s*h-i*o,x=s*c-n*o,w=r*h-i*a,v=r*c-n*a,M=i*c-n*h,k=l*y-u*f,T=l*g-d*f,E=l*m-p*f,R=u*g-d*y,_=u*m-p*y,B=d*m-p*g;return t[0]=a*B-h*_+c*R,t[1]=i*_-r*B-n*R,t[2]=y*M-g*v+m*w,t[3]=d*v-u*M-p*w,t[4]=h*E-o*B-c*T,t[5]=s*B-i*E+n*T,t[6]=g*x-f*M-m*b,t[7]=l*M-d*x+p*b,t[8]=o*_-a*E+c*k,t[9]=r*E-s*_-n*k,t[10]=f*v-y*x+m*A,t[11]=u*x-l*v-p*A,t[12]=a*T-o*R-h*k,t[13]=s*R-r*T+i*k,t[14]=y*b-f*w-g*A,t[15]=l*w-u*b+d*A,t}static determinant(t){const e=t[0],s=t[1],r=t[2],i=t[3],n=t[4],o=t[5],a=t[6],h=t[7],c=t[8],l=t[9],u=t[10],d=t[11],p=t[12],f=t[13],y=t[14],g=e*o-s*n,m=e*a-r*n,A=s*a-r*o,b=c*f-l*p,x=c*y-u*p,w=l*y-u*f;return h*(e*w-s*x+r*b)-i*(n*w-o*x+a*b)+t[15]*(c*A-l*m+u*g)-d*(p*A-f*m+y*g)}static multiply(t,e,s){const r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],h=e[5],c=e[6],l=e[7],u=e[8],d=e[9],p=e[10],f=e[11],y=e[12],g=e[13],m=e[14],A=e[15];let b=s[0],x=s[1],w=s[2],v=s[3];return t[0]=b*r+x*a+w*u+v*y,t[1]=b*i+x*h+w*d+v*g,t[2]=b*n+x*c+w*p+v*m,t[3]=b*o+x*l+w*f+v*A,b=s[4],x=s[5],w=s[6],v=s[7],t[4]=b*r+x*a+w*u+v*y,t[5]=b*i+x*h+w*d+v*g,t[6]=b*n+x*c+w*p+v*m,t[7]=b*o+x*l+w*f+v*A,b=s[8],x=s[9],w=s[10],v=s[11],t[8]=b*r+x*a+w*u+v*y,t[9]=b*i+x*h+w*d+v*g,t[10]=b*n+x*c+w*p+v*m,t[11]=b*o+x*l+w*f+v*A,b=s[12],x=s[13],w=s[14],v=s[15],t[12]=b*r+x*a+w*u+v*y,t[13]=b*i+x*h+w*d+v*g,t[14]=b*n+x*c+w*p+v*m,t[15]=b*o+x*l+w*f+v*A,t}static mul(t,e,s){return t}static translate(t,e,s){const r=s[0],i=s[1],n=s[2];if(e===t)t[12]=e[0]*r+e[4]*i+e[8]*n+e[12],t[13]=e[1]*r+e[5]*i+e[9]*n+e[13],t[14]=e[2]*r+e[6]*i+e[10]*n+e[14],t[15]=e[3]*r+e[7]*i+e[11]*n+e[15];else{const s=e[0],o=e[1],a=e[2],h=e[3],c=e[4],l=e[5],u=e[6],d=e[7],p=e[8],f=e[9],y=e[10],g=e[11];t[0]=s,t[1]=o,t[2]=a,t[3]=h,t[4]=c,t[5]=l,t[6]=u,t[7]=d,t[8]=p,t[9]=f,t[10]=y,t[11]=g,t[12]=s*r+c*i+p*n+e[12],t[13]=o*r+l*i+f*n+e[13],t[14]=a*r+u*i+y*n+e[14],t[15]=h*r+d*i+g*n+e[15]}return t}static scale(t,e,s){const r=s[0],i=s[1],n=s[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*i,t[5]=e[5]*i,t[6]=e[6]*i,t[7]=e[7]*i,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}static rotate(t,e,r,i){let n=i[0],o=i[1],a=i[2],h=Math.sqrt(n*n+o*o+a*a);if(h<s)return null;h=1/h,n*=h,o*=h,a*=h;const c=Math.sin(r),l=Math.cos(r),u=1-l,d=e[0],p=e[1],f=e[2],y=e[3],g=e[4],m=e[5],A=e[6],b=e[7],x=e[8],w=e[9],v=e[10],M=e[11],k=n*n*u+l,T=o*n*u+a*c,E=a*n*u-o*c,R=n*o*u-a*c,_=o*o*u+l,B=a*o*u+n*c,P=n*a*u+o*c,C=o*a*u-n*c,I=a*a*u+l;return t[0]=d*k+g*T+x*E,t[1]=p*k+m*T+w*E,t[2]=f*k+A*T+v*E,t[3]=y*k+b*T+M*E,t[4]=d*R+g*_+x*B,t[5]=p*R+m*_+w*B,t[6]=f*R+A*_+v*B,t[7]=y*R+b*_+M*B,t[8]=d*P+g*C+x*I,t[9]=p*P+m*C+w*I,t[10]=f*P+A*C+v*I,t[11]=y*P+b*C+M*I,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t}static rotateX(t,e,s){let r=Math.sin(s),i=Math.cos(s),n=e[4],o=e[5],a=e[6],h=e[7],c=e[8],l=e[9],u=e[10],d=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*i+c*r,t[5]=o*i+l*r,t[6]=a*i+u*r,t[7]=h*i+d*r,t[8]=c*i-n*r,t[9]=l*i-o*r,t[10]=u*i-a*r,t[11]=d*i-h*r,t}static rotateY(t,e,s){let r=Math.sin(s),i=Math.cos(s),n=e[0],o=e[1],a=e[2],h=e[3],c=e[8],l=e[9],u=e[10],d=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*i-c*r,t[1]=o*i-l*r,t[2]=a*i-u*r,t[3]=h*i-d*r,t[8]=n*r+c*i,t[9]=o*r+l*i,t[10]=a*r+u*i,t[11]=h*r+d*i,t}static rotateZ(t,e,s){let r=Math.sin(s),i=Math.cos(s),n=e[0],o=e[1],a=e[2],h=e[3],c=e[4],l=e[5],u=e[6],d=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*i+c*r,t[1]=o*i+l*r,t[2]=a*i+u*r,t[3]=h*i+d*r,t[4]=c*i-n*r,t[5]=l*i-o*r,t[6]=u*i-a*r,t[7]=d*i-h*r,t}static fromTranslation(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}static fromScaling(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static fromRotation(t,e,r){let i=r[0],n=r[1],o=r[2],a=Math.sqrt(i*i+n*n+o*o);if(a<s)return null;a=1/a,i*=a,n*=a,o*=a;const h=Math.sin(e),c=Math.cos(e),l=1-c;return t[0]=i*i*l+c,t[1]=n*i*l+o*h,t[2]=o*i*l-n*h,t[3]=0,t[4]=i*n*l-o*h,t[5]=n*n*l+c,t[6]=o*n*l+i*h,t[7]=0,t[8]=i*o*l+n*h,t[9]=n*o*l-i*h,t[10]=o*o*l+c,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static fromXRotation(t,e){let s=Math.sin(e),r=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=r,t[6]=s,t[7]=0,t[8]=0,t[9]=-s,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static fromYRotation(t,e){let s=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=0,t[2]=-s,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=s,t[9]=0,t[10]=r,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static fromZRotation(t,e){const s=Math.sin(e),r=Math.cos(e);return t[0]=r,t[1]=s,t[2]=0,t[3]=0,t[4]=-s,t[5]=r,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static fromRotationTranslation(t,e,s){const r=e[0],i=e[1],n=e[2],o=e[3],a=r+r,h=i+i,c=n+n,l=r*a,u=r*h,d=r*c,p=i*h,f=i*c,y=n*c,g=o*a,m=o*h,A=o*c;return t[0]=1-(p+y),t[1]=u+A,t[2]=d-m,t[3]=0,t[4]=u-A,t[5]=1-(l+y),t[6]=f+g,t[7]=0,t[8]=d+m,t[9]=f-g,t[10]=1-(l+p),t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1,t}static fromQuat2(t,e){const s=-e[0],r=-e[1],o=-e[2],a=e[3],h=e[4],c=e[5],l=e[6],u=e[7];let d=s*s+r*r+o*o+a*a;return d>0?(n[0]=2*(h*a+u*s+c*o-l*r)/d,n[1]=2*(c*a+u*r+l*s-h*o)/d,n[2]=2*(l*a+u*o+h*r-c*s)/d):(n[0]=2*(h*a+u*s+c*o-l*r),n[1]=2*(c*a+u*r+l*s-h*o),n[2]=2*(l*a+u*o+h*r-c*s)),i.fromRotationTranslation(t,e,n),t}static normalFromMat4(t,e){const s=e[0],r=e[1],i=e[2],n=e[3],o=e[4],a=e[5],h=e[6],c=e[7],l=e[8],u=e[9],d=e[10],p=e[11],f=e[12],y=e[13],g=e[14],m=e[15],A=s*a-r*o,b=s*h-i*o,x=s*c-n*o,w=r*h-i*a,v=r*c-n*a,M=i*c-n*h,k=l*y-u*f,T=l*g-d*f,E=l*m-p*f,R=u*g-d*y,_=u*m-p*y,B=d*m-p*g;let P=A*B-b*_+x*R+w*E-v*T+M*k;return P?(P=1/P,t[0]=(a*B-h*_+c*R)*P,t[1]=(h*E-o*B-c*T)*P,t[2]=(o*_-a*E+c*k)*P,t[3]=0,t[4]=(i*_-r*B-n*R)*P,t[5]=(s*B-i*E+n*T)*P,t[6]=(r*E-s*_-n*k)*P,t[7]=0,t[8]=(y*M-g*v+m*w)*P,t[9]=(g*x-f*M-m*b)*P,t[10]=(f*v-y*x+m*A)*P,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t):null}static normalFromMat4Fast(t,e){const s=e[0],r=e[1],i=e[2],n=e[4],o=e[5],a=e[6],h=e[8],c=e[9],l=e[10];return t[0]=o*l-l*c,t[1]=a*h-h*l,t[2]=n*c-c*h,t[3]=0,t[4]=c*i-l*r,t[5]=l*s-h*i,t[6]=h*r-c*s,t[7]=0,t[8]=r*a-i*o,t[9]=i*n-s*a,t[10]=s*o-r*n,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static getTranslation(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}static getScaling(t,e){const s=e[0],r=e[1],i=e[2],n=e[4],o=e[5],a=e[6],h=e[8],c=e[9],l=e[10];return t[0]=Math.sqrt(s*s+r*r+i*i),t[1]=Math.sqrt(n*n+o*o+a*a),t[2]=Math.sqrt(h*h+c*c+l*l),t}static getRotation(t,e){i.getScaling(n,e);const s=1/n[0],r=1/n[1],o=1/n[2],a=e[0]*s,h=e[1]*r,c=e[2]*o,l=e[4]*s,u=e[5]*r,d=e[6]*o,p=e[8]*s,f=e[9]*r,y=e[10]*o,g=a+u+y;let m=0;return g>0?(m=2*Math.sqrt(g+1),t[3]=.25*m,t[0]=(d-f)/m,t[1]=(p-c)/m,t[2]=(h-l)/m):a>u&&a>y?(m=2*Math.sqrt(1+a-u-y),t[3]=(d-f)/m,t[0]=.25*m,t[1]=(h+l)/m,t[2]=(p+c)/m):u>y?(m=2*Math.sqrt(1+u-a-y),t[3]=(p-c)/m,t[0]=(h+l)/m,t[1]=.25*m,t[2]=(d+f)/m):(m=2*Math.sqrt(1+y-a-u),t[3]=(h-l)/m,t[0]=(p+c)/m,t[1]=(d+f)/m,t[2]=.25*m),t}static decompose(t,e,s,r){e[0]=r[12],e[1]=r[13],e[2]=r[14];const i=r[0],n=r[1],o=r[2],a=r[4],h=r[5],c=r[6],l=r[8],u=r[9],d=r[10];s[0]=Math.sqrt(i*i+n*n+o*o),s[1]=Math.sqrt(a*a+h*h+c*c),s[2]=Math.sqrt(l*l+u*u+d*d);const p=1/s[0],f=1/s[1],y=1/s[2],g=i*p,m=n*f,A=o*y,b=a*p,x=h*f,w=c*y,v=l*p,M=u*f,k=d*y,T=g+x+k;let E=0;return T>0?(E=2*Math.sqrt(T+1),t[3]=.25*E,t[0]=(w-M)/E,t[1]=(v-A)/E,t[2]=(m-b)/E):g>x&&g>k?(E=2*Math.sqrt(1+g-x-k),t[3]=(w-M)/E,t[0]=.25*E,t[1]=(m+b)/E,t[2]=(v+A)/E):x>k?(E=2*Math.sqrt(1+x-g-k),t[3]=(v-A)/E,t[0]=(m+b)/E,t[1]=.25*E,t[2]=(w+M)/E):(E=2*Math.sqrt(1+k-g-x),t[3]=(m-b)/E,t[0]=(v+A)/E,t[1]=(w+M)/E,t[2]=.25*E),t}static fromRotationTranslationScale(t,e,s,r){const i=e[0],n=e[1],o=e[2],a=e[3],h=i+i,c=n+n,l=o+o,u=i*h,d=i*c,p=i*l,f=n*c,y=n*l,g=o*l,m=a*h,A=a*c,b=a*l,x=r[0],w=r[1],v=r[2];return t[0]=(1-(f+g))*x,t[1]=(d+b)*x,t[2]=(p-A)*x,t[3]=0,t[4]=(d-b)*w,t[5]=(1-(u+g))*w,t[6]=(y+m)*w,t[7]=0,t[8]=(p+A)*v,t[9]=(y-m)*v,t[10]=(1-(u+f))*v,t[11]=0,t[12]=s[0],t[13]=s[1],t[14]=s[2],t[15]=1,t}static fromRotationTranslationScaleOrigin(t,e,s,r,i){const n=e[0],o=e[1],a=e[2],h=e[3],c=n+n,l=o+o,u=a+a,d=n*c,p=n*l,f=n*u,y=o*l,g=o*u,m=a*u,A=h*c,b=h*l,x=h*u,w=r[0],v=r[1],M=r[2],k=i[0],T=i[1],E=i[2],R=(1-(y+m))*w,_=(p+x)*w,B=(f-b)*w,P=(p-x)*v,C=(1-(d+m))*v,I=(g+A)*v,S=(f+b)*M,N=(g-A)*M,O=(1-(d+y))*M;return t[0]=R,t[1]=_,t[2]=B,t[3]=0,t[4]=P,t[5]=C,t[6]=I,t[7]=0,t[8]=S,t[9]=N,t[10]=O,t[11]=0,t[12]=s[0]+k-(R*k+P*T+S*E),t[13]=s[1]+T-(_*k+C*T+N*E),t[14]=s[2]+E-(B*k+I*T+O*E),t[15]=1,t}static fromQuat(t,e){const s=e[0],r=e[1],i=e[2],n=e[3],o=s+s,a=r+r,h=i+i,c=s*o,l=r*o,u=r*a,d=i*o,p=i*a,f=i*h,y=n*o,g=n*a,m=n*h;return t[0]=1-u-f,t[1]=l+m,t[2]=d-g,t[3]=0,t[4]=l-m,t[5]=1-c-f,t[6]=p+y,t[7]=0,t[8]=d+g,t[9]=p-y,t[10]=1-c-u,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static frustumNO(t,e,s,r,i,n,o=1/0){const a=1/(s-e),h=1/(i-r);if(t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*h,t[6]=0,t[7]=0,t[8]=(s+e)*a,t[9]=(i+r)*h,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0){const e=1/(n-o);t[10]=(o+n)*e,t[14]=2*o*n*e}else t[10]=-1,t[14]=-2*n;return t}static frustum(t,e,s,r,i,n,o=1/0){return t}static frustumZO(t,e,s,r,i,n,o=1/0){const a=1/(s-e),h=1/(i-r);if(t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*h,t[6]=0,t[7]=0,t[8]=(s+e)*a,t[9]=(i+r)*h,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=o&&o!==1/0){const e=1/(n-o);t[10]=o*e,t[14]=o*n*e}else t[10]=-1,t[14]=-n;return t}static perspectiveNO(t,e,s,r,i=1/0){const n=1/Math.tan(e/2);if(t[0]=n/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0){const e=1/(r-i);t[10]=(i+r)*e,t[14]=2*i*r*e}else t[10]=-1,t[14]=-2*r;return t}static perspective(t,e,s,r,i=1/0){return t}static perspectiveZO(t,e,s,r,i=1/0){const n=1/Math.tan(e/2);if(t[0]=n/s,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,null!=i&&i!==1/0){const e=1/(r-i);t[10]=i*e,t[14]=i*r*e}else t[10]=-1,t[14]=-r;return t}static perspectiveFromFieldOfView(t,e,s,r){const i=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),h=2/(o+a),c=2/(i+n);return t[0]=h,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(o-a)*h*.5,t[9]=(i-n)*c*.5,t[10]=r/(s-r),t[11]=-1,t[12]=0,t[13]=0,t[14]=r*s/(s-r),t[15]=0,t}static orthoNO(t,e,s,r,i,n,o){const a=1/(e-s),h=1/(r-i),c=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+s)*a,t[13]=(i+r)*h,t[14]=(o+n)*c,t[15]=1,t}static ortho(t,e,s,r,i,n,o){return t}static orthoZO(t,e,s,r,i,n,o){const a=1/(e-s),h=1/(r-i),c=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*h,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=c,t[11]=0,t[12]=(e+s)*a,t[13]=(i+r)*h,t[14]=n*c,t[15]=1,t}static lookAt(t,e,r,n){const o=e[0],a=e[1],h=e[2],c=n[0],l=n[1],u=n[2],d=r[0],p=r[1],f=r[2];if(Math.abs(o-d)<s&&Math.abs(a-p)<s&&Math.abs(h-f)<s)return i.identity(t);let y=o-d,g=a-p,m=h-f,A=1/Math.sqrt(y*y+g*g+m*m);y*=A,g*=A,m*=A;let b=l*m-u*g,x=u*y-c*m,w=c*g-l*y;A=Math.sqrt(b*b+x*x+w*w),A?(A=1/A,b*=A,x*=A,w*=A):(b=0,x=0,w=0);let v=g*w-m*x,M=m*b-y*w,k=y*x-g*b;return A=Math.sqrt(v*v+M*M+k*k),A?(A=1/A,v*=A,M*=A,k*=A):(v=0,M=0,k=0),t[0]=b,t[1]=v,t[2]=y,t[3]=0,t[4]=x,t[5]=M,t[6]=g,t[7]=0,t[8]=w,t[9]=k,t[10]=m,t[11]=0,t[12]=-(b*o+x*a+w*h),t[13]=-(v*o+M*a+k*h),t[14]=-(y*o+g*a+m*h),t[15]=1,t}static targetTo(t,e,s,r){const i=e[0],n=e[1],o=e[2],a=r[0],h=r[1],c=r[2];let l=i-s[0],u=n-s[1],d=o-s[2],p=l*l+u*u+d*d;p>0&&(p=1/Math.sqrt(p),l*=p,u*=p,d*=p);let f=h*d-c*u,y=c*l-a*d,g=a*u-h*l;return p=f*f+y*y+g*g,p>0&&(p=1/Math.sqrt(p),f*=p,y*=p,g*=p),t[0]=f,t[1]=y,t[2]=g,t[3]=0,t[4]=u*g-d*y,t[5]=d*f-l*g,t[6]=l*y-u*f,t[7]=0,t[8]=l,t[9]=u,t[10]=d,t[11]=0,t[12]=i,t[13]=n,t[14]=o,t[15]=1,t}static frob(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]+t[3]*t[3]+t[4]*t[4]+t[5]*t[5]+t[6]*t[6]+t[7]*t[7]+t[8]*t[8]+t[9]*t[9]+t[10]*t[10]+t[11]*t[11]+t[12]*t[12]+t[13]*t[13]+t[14]*t[14]+t[15]*t[15])}static add(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t[4]=e[4]+s[4],t[5]=e[5]+s[5],t[6]=e[6]+s[6],t[7]=e[7]+s[7],t[8]=e[8]+s[8],t[9]=e[9]+s[9],t[10]=e[10]+s[10],t[11]=e[11]+s[11],t[12]=e[12]+s[12],t[13]=e[13]+s[13],t[14]=e[14]+s[14],t[15]=e[15]+s[15],t}static subtract(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t[4]=e[4]-s[4],t[5]=e[5]-s[5],t[6]=e[6]-s[6],t[7]=e[7]-s[7],t[8]=e[8]-s[8],t[9]=e[9]-s[9],t[10]=e[10]-s[10],t[11]=e[11]-s[11],t[12]=e[12]-s[12],t[13]=e[13]-s[13],t[14]=e[14]-s[14],t[15]=e[15]-s[15],t}static sub(t,e,s){return t}static multiplyScalar(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*s,t[9]=e[9]*s,t[10]=e[10]*s,t[11]=e[11]*s,t[12]=e[12]*s,t[13]=e[13]*s,t[14]=e[14]*s,t[15]=e[15]*s,t}static multiplyScalarAndAdd(t,e,s,r){return t[0]=e[0]+s[0]*r,t[1]=e[1]+s[1]*r,t[2]=e[2]+s[2]*r,t[3]=e[3]+s[3]*r,t[4]=e[4]+s[4]*r,t[5]=e[5]+s[5]*r,t[6]=e[6]+s[6]*r,t[7]=e[7]+s[7]*r,t[8]=e[8]+s[8]*r,t[9]=e[9]+s[9]*r,t[10]=e[10]+s[10]*r,t[11]=e[11]+s[11]*r,t[12]=e[12]+s[12]*r,t[13]=e[13]+s[13]*r,t[14]=e[14]+s[14]*r,t[15]=e[15]+s[15]*r,t}static exactEquals(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}static equals(t,e){const r=t[0],i=t[1],n=t[2],o=t[3],a=t[4],h=t[5],c=t[6],l=t[7],u=t[8],d=t[9],p=t[10],f=t[11],y=t[12],g=t[13],m=t[14],A=t[15],b=e[0],x=e[1],w=e[2],v=e[3],M=e[4],k=e[5],T=e[6],E=e[7],R=e[8],_=e[9],B=e[10],P=e[11],C=e[12],I=e[13],S=e[14],N=e[15];return Math.abs(r-b)<=s*Math.max(1,Math.abs(r),Math.abs(b))&&Math.abs(i-x)<=s*Math.max(1,Math.abs(i),Math.abs(x))&&Math.abs(n-w)<=s*Math.max(1,Math.abs(n),Math.abs(w))&&Math.abs(o-v)<=s*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(a-M)<=s*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(h-k)<=s*Math.max(1,Math.abs(h),Math.abs(k))&&Math.abs(c-T)<=s*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(l-E)<=s*Math.max(1,Math.abs(l),Math.abs(E))&&Math.abs(u-R)<=s*Math.max(1,Math.abs(u),Math.abs(R))&&Math.abs(d-_)<=s*Math.max(1,Math.abs(d),Math.abs(_))&&Math.abs(p-B)<=s*Math.max(1,Math.abs(p),Math.abs(B))&&Math.abs(f-P)<=s*Math.max(1,Math.abs(f),Math.abs(P))&&Math.abs(y-C)<=s*Math.max(1,Math.abs(y),Math.abs(C))&&Math.abs(g-I)<=s*Math.max(1,Math.abs(g),Math.abs(I))&&Math.abs(m-S)<=s*Math.max(1,Math.abs(m),Math.abs(S))&&Math.abs(A-N)<=s*Math.max(1,Math.abs(A),Math.abs(N))}static str(t){return`Mat4(${t.join(", ")})`}}const n=new Float32Array(3);i.prototype.mul=i.prototype.multiply,i.sub=i.subtract,i.mul=i.multiply,i.frustum=i.frustumNO,i.perspective=i.perspectiveNO,i.ortho=i.orthoNO;const o=i;class a extends Float32Array{static BYTE_LENGTH=(()=>4*Float32Array.BYTES_PER_ELEMENT)();constructor(...t){switch(t.length){case 4:super(t);break;case 2:super(t[0],t[1],4);break;case 1:{const e=t[0];"number"==typeof e?super([e,e,e,e]):super(e,0,4);break}default:super(4)}}get x(){return this[0]}set x(t){this[0]=t}get y(){return this[1]}set y(t){this[1]=t}get z(){return this[2]}set z(t){this[2]=t}get w(){return this[3]}set w(t){this[3]=t}get r(){return this[0]}set r(t){this[0]=t}get g(){return this[1]}set g(t){this[1]=t}get b(){return this[2]}set b(t){this[2]=t}get a(){return this[3]}set a(t){this[3]=t}get magnitude(){const t=this[0],e=this[1],s=this[2],r=this[3];return Math.sqrt(t*t+e*e+s*s+r*r)}get mag(){return this.magnitude}get str(){return a.str(this)}copy(t){return super.set(t),this}add(t){return this[0]+=t[0],this[1]+=t[1],this[2]+=t[2],this[3]+=t[3],this}subtract(t){return this[0]-=t[0],this[1]-=t[1],this[2]-=t[2],this[3]-=t[3],this}sub(t){return this}multiply(t){return this[0]*=t[0],this[1]*=t[1],this[2]*=t[2],this[3]*=t[3],this}mul(t){return this}divide(t){return this[0]/=t[0],this[1]/=t[1],this[2]/=t[2],this[3]/=t[3],this}div(t){return this}scale(t){return this[0]*=t,this[1]*=t,this[2]*=t,this[3]*=t,this}scaleAndAdd(t,e){return this[0]+=t[0]*e,this[1]+=t[1]*e,this[2]+=t[2]*e,this[3]+=t[3]*e,this}distance(t){return a.distance(this,t)}dist(t){return 0}squaredDistance(t){return a.squaredDistance(this,t)}sqrDist(t){return 0}negate(){return this[0]*=-1,this[1]*=-1,this[2]*=-1,this[3]*=-1,this}invert(){return this[0]=1/this[0],this[1]=1/this[1],this[2]=1/this[2],this[3]=1/this[3],this}abs(){return this[0]=Math.abs(this[0]),this[1]=Math.abs(this[1]),this[2]=Math.abs(this[2]),this[3]=Math.abs(this[3]),this}dot(t){return this[0]*t[0]+this[1]*t[1]+this[2]*t[2]+this[3]*t[3]}normalize(){return a.normalize(this,this)}static create(){return new a}static clone(t){return new a(t)}static fromValues(t,e,s,r){return new a(t,e,s,r)}static copy(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}static set(t,e,s,r,i){return t[0]=e,t[1]=s,t[2]=r,t[3]=i,t}static add(t,e,s){return t[0]=e[0]+s[0],t[1]=e[1]+s[1],t[2]=e[2]+s[2],t[3]=e[3]+s[3],t}static subtract(t,e,s){return t[0]=e[0]-s[0],t[1]=e[1]-s[1],t[2]=e[2]-s[2],t[3]=e[3]-s[3],t}static sub(t,e,s){return t}static multiply(t,e,s){return t[0]=e[0]*s[0],t[1]=e[1]*s[1],t[2]=e[2]*s[2],t[3]=e[3]*s[3],t}static mul(t,e,s){return t}static divide(t,e,s){return t[0]=e[0]/s[0],t[1]=e[1]/s[1],t[2]=e[2]/s[2],t[3]=e[3]/s[3],t}static div(t,e,s){return t}static ceil(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}static floor(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}static min(t,e,s){return t[0]=Math.min(e[0],s[0]),t[1]=Math.min(e[1],s[1]),t[2]=Math.min(e[2],s[2]),t[3]=Math.min(e[3],s[3]),t}static max(t,e,s){return t[0]=Math.max(e[0],s[0]),t[1]=Math.max(e[1],s[1]),t[2]=Math.max(e[2],s[2]),t[3]=Math.max(e[3],s[3]),t}static round(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}static scale(t,e,s){return t[0]=e[0]*s,t[1]=e[1]*s,t[2]=e[2]*s,t[3]=e[3]*s,t}static scaleAndAdd(t,e,s,r){return t[0]=e[0]+s[0]*r,t[1]=e[1]+s[1]*r,t[2]=e[2]+s[2]*r,t[3]=e[3]+s[3]*r,t}static distance(t,e){const s=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],n=e[3]-t[3];return Math.hypot(s,r,i,n)}static dist(t,e){return 0}static squaredDistance(t,e){const s=e[0]-t[0],r=e[1]-t[1],i=e[2]-t[2],n=e[3]-t[3];return s*s+r*r+i*i+n*n}static sqrDist(t,e){return 0}static magnitude(t){const e=t[0],s=t[1],r=t[2],i=t[3];return Math.sqrt(e*e+s*s+r*r+i*i)}static mag(t){return 0}static length(t){return 0}static len(t){return 0}static squaredLength(t){const e=t[0],s=t[1],r=t[2],i=t[3];return e*e+s*s+r*r+i*i}static sqrLen(t){return 0}static negate(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}static inverse(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}static abs(t,e){return t[0]=Math.abs(e[0]),t[1]=Math.abs(e[1]),t[2]=Math.abs(e[2]),t[3]=Math.abs(e[3]),t}static normalize(t,e){const s=e[0],r=e[1],i=e[2],n=e[3];let o=s*s+r*r+i*i+n*n;return o>0&&(o=1/Math.sqrt(o)),t[0]=s*o,t[1]=r*o,t[2]=i*o,t[3]=n*o,t}static dot(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}static cross(t,e,s,r){const i=s[0]*r[1]-s[1]*r[0],n=s[0]*r[2]-s[2]*r[0],o=s[0]*r[3]-s[3]*r[0],a=s[1]*r[2]-s[2]*r[1],h=s[1]*r[3]-s[3]*r[1],c=s[2]*r[3]-s[3]*r[2],l=e[0],u=e[1],d=e[2],p=e[3];return t[0]=u*c-d*h+p*a,t[1]=-l*c+d*o-p*n,t[2]=l*h-u*o+p*i,t[3]=-l*a+u*n-d*i,t}static lerp(t,e,s,r){const i=e[0],n=e[1],o=e[2],a=e[3];return t[0]=i+r*(s[0]-i),t[1]=n+r*(s[1]-n),t[2]=o+r*(s[2]-o),t[3]=a+r*(s[3]-a),t}static transformMat4(t,e,s){const r=e[0],i=e[1],n=e[2],o=e[3];return t[0]=s[0]*r+s[4]*i+s[8]*n+s[12]*o,t[1]=s[1]*r+s[5]*i+s[9]*n+s[13]*o,t[2]=s[2]*r+s[6]*i+s[10]*n+s[14]*o,t[3]=s[3]*r+s[7]*i+s[11]*n+s[15]*o,t}static transformQuat(t,e,s){const r=e[0],i=e[1],n=e[2],o=s[0],a=s[1],h=s[2],c=s[3],l=c*r+a*n-h*i,u=c*i+h*r-o*n,d=c*n+o*i-a*r,p=-o*r-a*i-h*n;return t[0]=l*c+p*-o+u*-h-d*-a,t[1]=u*c+p*-a+d*-o-l*-h,t[2]=d*c+p*-h+l*-a-u*-o,t[3]=e[3],t}static zero(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=0,t}static str(t){return`Vec4(${t.join(", ")})`}static exactEquals(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}static equals(t,e){const r=t[0],i=t[1],n=t[2],o=t[3],a=e[0],h=e[1],c=e[2],l=e[3];return Math.abs(r-a)<=s*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(i-h)<=s*Math.max(1,Math.abs(i),Math.abs(h))&&Math.abs(n-c)<=s*Math.max(1,Math.abs(n),Math.abs(c))&&Math.abs(o-l)<=s*Math.max(1,Math.abs(o),Math.abs(l))}}a.prototype.sub=a.prototype.subtract,a.prototype.mul=a.prototype.multiply,a.prototype.div=a.prototype.divide,a.prototype.dist=a.prototype.distance,a.prototype.sqrDist=a.prototype.squaredDistance,a.sub=a.subtract,a.mul=a.multiply,a.div=a.divide,a.dist=a.distance,a.sqrDist=a.squaredDistance,a.sqrLen=a.squaredLength,a.mag=a.magnitude,a.length=a.magnitude,a.len=a.magnitude;const h=a,c={UP:1,DOWN:2,LEFT:3,RIGHT:4,FORWARD:5,BACK:6};function l(t,e,s,r,i){t.push(...e,...s,...r,...i,...e,...r)}const u={validateBlockType(t){const e={id:0,spawnable:!1,transparent:!0,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[0,0,1,1]}};if(!t)return this.AIR;const s={...e,...t};"function"!=typeof s.texture&&(s.texture=e.texture);const r=s.texture;return s.texture=function(...t){return e=r.apply(this,t),Array.isArray(e)&&4===e.length?e.map((t=>Math.max(0,Math.min(1,t)))):(console.warn("Invalid texture coordinates, using default"),[0,0,1,1]);var e},s},fromId(t){if(void 0===t||t<0)return console.warn(`Invalid block id: ${t}, using AIR`),this.AIR;for(const e in this)if(this[e]&&"object"==typeof this[e]&&this[e].id===t)return this.validateBlockType(this[e]);return console.warn(`Unknown block id: ${t}, using AIR`),this.AIR},pushVertices(t,e,s,r,i,n){const o=e.blocks,a=n>=s[r][i],h=o[r][i][n];if(!h)return;const u=!h.fluid||n!=e.sz-1&&o[r][i][n+1].fluid?1:.9;if(n==e.sz-1||e.blocks[r][i][n+1].transparent||h.fluid){const o=h.texture(e,s,a,r,i,n,c.UP),d=h.selflit||n>=s[r][i]?1:.6;l(t,[r,i,n+u,o[0],o[1],d,d,d,1],[r+1,i,n+u,o[2],o[1],d,d,d,1],[r+1,i+1,n+u,o[2],o[3],d,d,d,1],[r,i+1,n+u,o[0],o[3],d,d,d,1])}if(0==n||e.blocks[r][i][n-1].transparent){const o=h.texture(e,s,a,r,i,n,c.DOWN),u=h.selflit?1:.6;l(t,[r,i+1,n,o[0],o[3],u,u,u,1],[r+1,i+1,n,o[2],o[3],u,u,u,1],[r+1,i,n,o[2],o[1],u,u,u,1],[r,i,n,o[0],o[1],u,u,u,1])}if(0==i||e.blocks[r][i-1][n].transparent){const o=h.texture(e,s,a,r,i,n,c.FORWARD),d=h.selflit||0==i||n>=s[r][i-1]?1:.6;l(t,[r,i,n,o[0],o[3],d,d,d,1],[r+1,i,n,o[2],o[3],d,d,d,1],[r+1,i,n+u,o[2],o[1],d,d,d,1],[r,i,n+u,o[0],o[1],d,d,d,1])}if(i==e.sy-1||e.blocks[r][i+1][n].transparent){const o=h.texture(e,s,a,r,i,n,c.BACK),d=h.selflit?1:.6;l(t,[r,i+1,n+u,o[0],o[1],d,d,d,1],[r+1,i+1,n+u,o[2],o[1],d,d,d,1],[r+1,i+1,n,o[2],o[3],d,d,d,1],[r,i+1,n,o[0],o[3],d,d,d,1])}if(0==r||e.blocks[r-1][i][n].transparent){const o=h.texture(e,s,a,r,i,n,c.LEFT),d=h.selflit?1:.6;l(t,[r,i,n+u,o[0],o[1],d,d,d,1],[r,i+1,n+u,o[2],o[1],d,d,d,1],[r,i+1,n,o[2],o[3],d,d,d,1],[r,i,n,o[0],o[3],d,d,d,1])}if(r==e.sx-1||e.blocks[r+1][i][n].transparent){const o=h.texture(e,s,a,r,i,n,c.RIGHT),d=h.selflit||r==e.sx-1||n>=s[r+1][i]?1:.6;l(t,[r+1,i,n,o[0],o[3],d,d,d,1],[r+1,i+1,n,o[2],o[3],d,d,d,1],[r+1,i+1,n+u,o[2],o[1],d,d,d,1],[r+1,i,n+u,o[0],o[1],d,d,d,1])}},pushPickingVertices(t,e,s,r){const i={r:e/255,g:s/255,b:r/255};[c.UP,c.DOWN,c.FORWARD,c.BACK,c.LEFT,c.RIGHT].forEach(((n,o)=>{l(t,[e,s,r,0,0,i.r,i.g,i.b,(o+1)/255],[e+1,s,r,1,0,i.r,i.g,i.b,(o+1)/255],[e+1,s+1,r,1,1,i.r,i.g,i.b,(o+1)/255],[e,s+1,r,0,0,i.r,i.g,i.b,(o+1)/255])}))}};u.AIR=u.validateBlockType({id:0,spawnable:!1,transparent:!0,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[0,0,1,1]}}),u.BEDROCK=u.validateBlockType({id:1,spawnable:!1,transparent:!1,texture:function(t,e,s,r,i,n,o){return[1/16,1/16,2/16,2/16]}}),u.DIRT=u.validateBlockType({id:2,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){let a;return a=o==c.UP&&s?[.875,0,15/16,1/16]:o!=c.DOWN&&s?[3/16,0,.25,1/16]:[2/16,0,3/16,1/16],a}}),u.WOOD=u.validateBlockType({id:3,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return o==c.UP||o==c.DOWN?[5/16,1/16,6/16,2/16]:[.25,1/16,5/16,2/16]}}),u.TNT=u.validateBlockType({id:4,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return o==c.UP||o==c.DOWN?[.625,0,11/16,1/16]:[.5,0,9/16,1/16]}}),u.BOOKCASE=u.validateBlockType({id:5,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return o==c.FORWARD||o==c.BACK?[3/16,2/16,.25,3/16]:[.25,0,5/16,1/16]}}),u.LAVA=u.validateBlockType({id:6,spawnable:!1,transparent:!0,selflit:!0,gravity:!0,fluid:!0,texture:function(t,e,s,r,i,n,o){return[13/16,.875,.875,15/16]}}),u.PLANK=u.validateBlockType({id:7,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[.25,0,5/16,1/16]}}),u.COBBLESTONE=u.validateBlockType({id:8,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[0,1/16,1/16,2/16]}}),u.CONCRETE=u.validateBlockType({id:9,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[1/16,0,2/16,1/16]}}),u.BRICK=u.validateBlockType({id:10,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[7/16,0,.5,1/16]}}),u.SAND=u.validateBlockType({id:11,spawnable:!0,transparent:!1,selflit:!1,gravity:!0,fluid:!1,texture:function(t,e,s,r,i,n,o){return[2/16,1/16,3/16,2/16]}}),u.GRAVEL=u.validateBlockType({id:12,spawnable:!0,transparent:!1,selflit:!1,gravity:!0,fluid:!1,texture:function(t,e,s,r,i,n,o){return[3/16,1/16,.25,2/16]}}),u.IRON=u.validateBlockType({id:13,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[6/16,1/16,7/16,2/16]}}),u.GOLD=u.validateBlockType({id:14,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[7/16,1/16,.5,2/16]}}),u.DIAMOND=u.validateBlockType({id:15,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[.5,1/16,9/16,2/16]}}),u.OBSIDIAN=u.validateBlockType({id:16,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[5/16,2/16,6/16,3/16]}}),u.GLASS=u.validateBlockType({id:17,spawnable:!0,transparent:!0,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[1/16,3/16,2/16,.25]}}),u.SPONGE=u.validateBlockType({id:18,spawnable:!0,transparent:!1,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[0,3/16,1/16,.25]}}),u.WATER=u.validateBlockType({id:19,spawnable:!1,transparent:!0,selflit:!1,gravity:!0,fluid:!0,texture:function(t,e,s,r,i,n,o){return[13/16,.75,.875,13/16]}}),u.LEAVES=u.validateBlockType({id:20,spawnable:!0,transparent:!0,selflit:!1,gravity:!1,fluid:!1,texture:function(t,e,s,r,i,n,o){return[.25,3/16,5/16,.25]}});class d{constructor(t,e,s){this.x=t,this.y=e,this.z=s}add(t){return new d(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new d(this.x-t.x,this.y-t.y,this.z-t.z)}mul(t){return new d(this.x*t,this.y*t,this.z*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}distance(t){return this.sub(t).length()}normal(){if(0===this.x&&0===this.y&&0===this.z)return new d(0,0,0);const t=this.length();return new d(this.x/t,this.y/t,this.z/t)}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}toArray(){return[this.x,this.y,this.z]}toString(){return`( ${this.x}, ${this.y}, ${this.z} )`}}const p=(t,e)=>null!=t.y?e.y>t.y-e.size/2&&e.y<t.y+e.size/2&&e.x>t.x1-e.size/2&&e.x<t.x2+e.size/2:e.x>t.x-e.size/2&&e.x<t.x+e.size/2&&e.y>t.y1-e.size/2&&e.y<t.y2+e.size/2,f=(t,e)=>e.x1>t.x1&&e.x1<t.x2&&e.y1>t.y1&&e.y1<t.y2||e.x2>t.x1&&e.x2<t.x2&&e.y1>t.y1&&e.y1<t.y2||e.x2>t.x1&&e.x2<t.x2&&e.y2>t.y1&&e.y2<t.y2||e.x1>t.x1&&e.x1<t.x2&&e.y2>t.y1&&e.y2<t.y2;void 0!==t&&(t.Vector=d,t.rectRectCollide=f,t.lineRectCollide=p);const y=1/3,g=1/6,m=t=>0|Math.floor(t),A=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]);function b(t=Math.random){const e=function(t){const e=512,s=new Uint8Array(e);for(let r=0;r<e/2;r++)s[r]=r;for(let r=0;r<e/2-1;r++){const e=r+~~(t()*(256-r)),i=s[r];s[r]=s[e],s[e]=i}for(let r=256;r<e;r++)s[r]=s[r-256];return s}(t),s=new Float64Array(e).map((t=>A[t%12*3])),r=new Float64Array(e).map((t=>A[t%12*3+1])),i=new Float64Array(e).map((t=>A[t%12*3+2]));return function(t,n,o){let a,h,c,l;const u=(t+n+o)*y,d=m(t+u),p=m(n+u),f=m(o+u),A=(d+p+f)*g,b=t-(d-A),x=n-(p-A),w=o-(f-A);let v,M,k,T,E,R;b>=x?x>=w?(v=1,M=0,k=0,T=1,E=1,R=0):b>=w?(v=1,M=0,k=0,T=1,E=0,R=1):(v=0,M=0,k=1,T=1,E=0,R=1):x<w?(v=0,M=0,k=1,T=0,E=1,R=1):b<w?(v=0,M=1,k=0,T=0,E=1,R=1):(v=0,M=1,k=0,T=1,E=1,R=0);const _=b-v+g,B=x-M+g,P=w-k+g,C=b-T+2*g,I=x-E+2*g,S=w-R+2*g,N=b-1+.5,O=x-1+.5,L=w-1+.5,D=255&d,F=255&p,U=255&f;let z=.6-b*b-x*x-w*w;if(z<0)a=0;else{const t=D+e[F+e[U]];z*=z,a=z*z*(s[t]*b+r[t]*x+i[t]*w)}let q=.6-_*_-B*B-P*P;if(q<0)h=0;else{const t=D+v+e[F+M+e[U+k]];q*=q,h=q*q*(s[t]*_+r[t]*B+i[t]*P)}let H=.6-C*C-I*I-S*S;if(H<0)c=0;else{const t=D+T+e[F+E+e[U+R]];H*=H,c=H*H*(s[t]*C+r[t]*I+i[t]*S)}let V=.6-N*N-O*O-L*L;if(V<0)l=0;else{const t=D+1+e[F+1+e[U+1]];V*=V,l=V*V*(s[t]*N+r[t]*O+i[t]*L)}return 32*(a+h+c+l)}}function x(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var w,v={exports:{}},M=(w||(w=1,function(t){t.exports=function(){return t.importState=function(e){var s=new t;return s.importState(e),s},t;function t(){return function(t){var s=0,r=0,i=0,n=1;0==t.length&&(t=[+new Date]);var o=e();s=o(" "),r=o(" "),i=o(" ");for(var a=0;a<t.length;a++)(s-=o(t[a]))<0&&(s+=1),(r-=o(t[a]))<0&&(r+=1),(i-=o(t[a]))<0&&(i+=1);o=null;var h=function(){var t=2091639*s+2.3283064365386963e-10*n;return s=r,r=i,i=t-(n=0|t)};return h.next=h,h.uint32=function(){return 4294967296*h()},h.fract53=function(){return h()+11102230246251565e-32*(2097152*h()|0)},h.version="Alea 0.9",h.args=t,h.exportState=function(){return[s,r,i,n]},h.importState=function(t){s=+t[0]||0,r=+t[1]||0,i=+t[2]||0,n=+t[3]||0},h}(Array.prototype.slice.call(arguments))}function e(){var t=4022871197,e=function(e){e=e.toString();for(var s=0;s<e.length;s++){var r=.02519603282416938*(t+=e.charCodeAt(s));r-=t=r>>>0,t=(r*=t)>>>0,t+=4294967296*(r-=t)}return 2.3283064365386963e-10*(t>>>0)};return e.version="Mash 0.9",e}}()}(v)),v.exports);const k=x(M);let T=class{constructor(t,e,s){if(t<=0||e<=0||s<=0)throw new Error("World dimensions must be positive non-zero values.");this.sx=t,this.sy=e,this.sz=s,this.spawnPoint=new d(Math.floor(t/2),Math.floor(e/2),Math.floor(s/2)),this.blocks=this.generateTerrain(t,e,s),this.players={},console.log("World created with dimensions:",t,e,s)}isInBounds(t,e,s){return t>=0&&t<this.sx&&e>=0&&e<this.sy&&s>=0&&s<this.sz}validateBlock(t){return t&&"number"==typeof t.id?u.validateBlockType(t):(console.warn("Invalid block detected, replacing with AIR block"),u.AIR)}generateTerrain(t,e,s){try{const r=b(k("minecraft")),i=new Array(t).fill(null).map((()=>new Array(e).fill(null).map((()=>new Array(s).fill(u.AIR)))));for(let s=0;s<t;s++)for(let t=0;t<e;t++)i[s][t][0]=this.validateBlock(u.BEDROCK);const n=64,o=s/3,a=.5,h=4;for(let l=0;l<t;l++)for(let t=0;t<e;t++){const e=r(l/n,t/n,0),c=Math.floor(.5*(e+1)*o);for(let n=0;n<s;n++){let e=0,o=1,d=a;for(let s=0;s<h;s++)e+=d*r(l*o/32,t*o/32,n/32),o*=2,d*=.5;const p=c+Math.floor(8*e);i[l][t][n]=n<p?this.validateBlock(u.DIRT):n<s/2?this.validateBlock(u.WATER):this.validateBlock(u.AIR)}}for(let l=0;l<t;l++)for(let t=0;t<e;t++)for(let e=s/2;e<s;e++)i[l][t][e]===u.DIRT&&Math.random()<.05&&this.addTree(i,l,t,e+1);const c=Math.floor(t*e*s*1e-4);for(let l=0;l<c;l++){const r=Math.floor(Math.random()*t),n=Math.floor(Math.random()*e),o=Math.floor(Math.random()*(s/2));this.isInBounds(r,n,o)&&this.addCave(i,r,n,o)}for(let l=0;l<t;l++)for(let t=0;t<e;t++)for(let e=0;e<s;e++)i[l][t][e]=this.validateBlock(i[l][t][e]);return console.log("Minecraft-like noise terrain with water, trees, and caves generated"),i}catch(r){return console.error("Failed to generate terrain:",r),this.createFlatWorld(Math.floor(s/2))}}addTree(t,e,s,r){if(!this.isInBounds(e,s,r))return;const i=5+Math.floor(3*Math.random());for(let o=0;o<i;o++)r+o<t[0][0].length&&(t[e][s][r+o]=u.WOOD);const n=r+i-2;for(let o=-2;o<=2;o++)for(let r=-2;r<=2;r++)for(let i=0;i<=2;i++)Math.abs(o)+Math.abs(r)+i<=3&&e+o>=0&&e+o<t.length&&s+r>=0&&s+r<t[0].length&&n+i<t[0][0].length&&(t[e+o][s+r][n+i]=u.LEAVES)}addCave(t,e,s,r){if(!this.isInBounds(e,s,r))return;const i=10+Math.floor(20*Math.random());let n=e,o=s,a=r,h=2*Math.random()-1,c=2*Math.random()-1,l=2*Math.random()-1,d=0;for(;d<1e3&&d<i;){const e=Math.floor(n),s=Math.floor(o),r=Math.floor(a);if(!this.isInBounds(e,s,r))break;t[e][s][r]=u.AIR;for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++)for(let o=-1;o<=1;o++){const a=e+i,h=s+n,c=r+o;this.isInBounds(a,h,c)&&Math.random()<.3&&(t[a][h][c]=u.AIR)}n+=h,o+=c,a+=l,h+=.1*(Math.random()-.5),c+=.1*(Math.random()-.5),l+=.1*(Math.random()-.5),h=Math.max(-1,Math.min(1,h)),c=Math.max(-1,Math.min(1,c)),l=Math.max(-1,Math.min(1,l)),d++}}createFlatWorld(t){if(t<0||t>this.sz)throw new Error("Invalid height for flat world.");this.spawnPoint=new d(this.sx/2+.5,this.sy/2+.5,t);const e=new Array(this.sx).fill(null).map((()=>new Array(this.sy).fill(null).map((()=>new Array(this.sz).fill(u.AIR)))));for(let s=0;s<this.sx;s++)for(let r=0;r<this.sy;r++)for(let i=0;i<this.sz;i++)e[s][r][i]=i<t?u.DIRT:u.AIR;return e}createFromString(t){if(t.length!==this.sx*this.sy*this.sz)throw new Error("String length does not match world dimensions.");console.log("Creating world from string:",t);let e=0;for(let s=0;s<this.sx;s++)for(let r=0;r<this.sy;r++)for(let i=0;i<this.sz;i++)this.blocks[s][r][i]=u.fromId(t.charCodeAt(e)-97),e++;console.log("World created from string successfully")}getBlock(t,e,s){return t<0||e<0||s<0||t>=this.sx||e>=this.sy||s>=this.sz?u.AIR:this.validateBlock(this.blocks[t][e][s])}setBlock(t,e,s,r){if(!this.isInBounds(t,e,s))return!1;try{return this.blocks[t][e][s]=this.validateBlock(r),this.renderer&&this.renderer.onBlockChanged(t,e,s),!0}catch(i){return console.error(`Failed to set block at (${t}, ${e}, ${s}):`,i),!1}}toNetworkString(){const t=[];for(let e=0;e<this.sx;e++)for(let s=0;s<this.sy;s++)for(let r=0;r<this.sz;r++){const i=this.validateBlock(this.blocks[e][s][r]);t.push(String.fromCharCode(97+i.id))}return t.join("")}};void 0!==t&&(t.World=T);class E{constructor(t){const e=this.canvas=document.getElementById(t);let s;e.renderer=this,e.width=e.clientWidth,e.height=e.clientHeight;try{if(s=this.gl=e.getContext("webgl2")||e.getContext("webgl"),!s)throw new Error("WebGL not supported")}catch(d){throw new Error("WebGL initialization failed: "+d.message)}e.addEventListener("webglcontextlost",(t=>{t.preventDefault(),this.handleContextLost()}),!1),e.addEventListener("webglcontextrestored",(()=>{this.handleContextRestored()}),!1),s.viewportWidth=e.width,s.viewportHeight=e.height,s.clearColor(.62,.81,1,1),s.enable(s.DEPTH_TEST),s.enable(s.CULL_FACE),s.blendFunc(s.SRC_ALPHA,s.ONE_MINUS_SRC_ALPHA),this.loadShaders(),this.loadPlayerHeadModel(),this.loadPlayerBodyModel(),this.projMatrix=o.create(),this.viewMatrix=o.create();const r=this.modelMatrix=o.create();o.identity(r),s.uniformMatrix4fv(this.uModelMat,!1,r);const i=this.texWhite=s.createTexture();s.activeTexture(s.TEXTURE0),s.bindTexture(s.TEXTURE_2D,i);const n=new Uint8Array([255,255,255,255]);s.texImage2D(s.TEXTURE_2D,0,s.RGBA,1,1,0,s.RGBA,s.UNSIGNED_BYTE,n),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.uniform1i(this.uSampler,0);const a=this.texPlayer=s.createTexture();a.image=new Image,a.image.onload=()=>{s.bindTexture(s.TEXTURE_2D,a),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,a.image),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),this.playerTextureLoaded=!0},a.image.onerror=()=>{console.error("Failed to load player texture")},a.image.src="media/player.png";const c=this.texTerrain=s.createTexture();c.image=new Image,c.image.onload=()=>{s.bindTexture(s.TEXTURE_2D,c),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,c.image),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST)},c.image.src="media/terrain.png";const l=this.textCanvas=document.createElement("canvas");l.width=256,l.height=64,l.style.display="none";const u=this.textContext=l.getContext("2d");u.textAlign="left",u.textBaseline="middle",u.font="24px Minecraftia",document.body.appendChild(l),this.frustumPlanes=[h.create(),h.create(),h.create(),h.create(),h.create(),h.create()],this.setWorld(new T(100,100,50),16),console.log("Renderer initialized")}draw(){if(this.contextLost)return;const t=this.gl;this.updateViewport(),t.viewport(0,0,t.viewportWidth,t.viewportHeight),t.clear(t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT),this.updateFrustumPlanes();const e=this.chunks;if(t.bindTexture(t.TEXTURE_2D,this.texTerrain),null!=e)for(let r=0;r<e.length;r++)null!=e[r].buffer&&this.isChunkInFrustum(e[r])&&this.drawBuffer(e[r].buffer);const s=this.world.players;t.enable(t.BLEND);for(const r in s){const e=s[r];let i;e.moving||Math.abs(e.aniframe)>.1?(e.aniframe+=.15,e.aniframe>Math.PI&&(e.aniframe=-Math.PI),i=Math.PI/2*Math.sin(e.aniframe),!e.moving&&Math.abs(i)<.1&&(e.aniframe=0)):i=0;let n=e.pitch;n<-.32&&(n=-.32),n>.32&&(n=.32),o.identity(this.modelMatrix),o.translate(this.modelMatrix,[e.x,e.y,e.z+1.7]),o.rotateZ(this.modelMatrix,Math.PI-e.yaw),o.rotateX(this.modelMatrix,-n),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),t.bindTexture(t.TEXTURE_2D,this.texPlayer),this.drawBuffer(this.playerHead),o.identity(this.modelMatrix),o.translate(this.modelMatrix,[e.x,e.y,e.z+.01]),o.rotateZ(this.modelMatrix,Math.PI-e.yaw),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),this.drawBuffer(this.playerBody),o.translate(this.modelMatrix,[0,0,1.4]),o.rotateX(this.modelMatrix,.75*i),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),this.drawBuffer(this.playerLeftArm),o.rotateX(this.modelMatrix,-1.5*i),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),this.drawBuffer(this.playerRightArm),o.rotateX(this.modelMatrix,.75*i),o.translate(this.modelMatrix,[0,0,-.67]),o.rotateX(this.modelMatrix,.5*i),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),this.drawBuffer(this.playerRightLeg),o.rotateX(this.modelMatrix,-i),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),this.drawBuffer(this.playerLeftLeg),e.nametag||(e.nametag=this.buildPlayerName(e.nick));const a=-Math.PI/2+Math.atan2(this.camPos[1]-e.y,this.camPos[0]-e.x);o.identity(this.modelMatrix),o.translate(this.modelMatrix,[e.x,e.y,e.z+2.05]),o.rotateZ(this.modelMatrix,a),o.scale(this.modelMatrix,[.005,1,.005]),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),t.bindTexture(t.TEXTURE_2D,e.nametag.texture),this.drawBuffer(e.nametag.model)}t.disable(t.BLEND),o.identity(this.modelMatrix),t.uniformMatrix4fv(this.uModelMat,!1,this.modelMatrix),console.log("Frame rendered")}buildPlayerName(t){const e=this.gl,s=this.textCanvas,r=this.textContext;t=t.replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/,'"');const i=r.measureText(t).width+16,n=45;r.fillStyle="#000",r.fillRect(0,0,i,45),r.fillStyle="#fff",r.fillText(t,10,20);const o=e.createTexture();e.bindTexture(e.TEXTURE_2D,o),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,s),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR);const a=[-i/2,0,n,i/256,0,1,1,1,.7,i/2,0,n,0,0,1,1,1,.7,i/2,0,0,0,n/64,1,1,1,.7,i/2,0,0,0,n/64,1,1,1,.7,-i/2,0,0,i/256,n/64,1,1,1,.7,-i/2,0,n,i/256,0,1,1,1,.7],h=e.createBuffer();return h.vertices=a.length/9,e.bindBuffer(e.ARRAY_BUFFER,h),e.bufferData(e.ARRAY_BUFFER,new Float32Array(a),e.STATIC_DRAW),{texture:o,model:h}}pickAt(t,e,s,r){const i=this.gl,n=this.world,o=i.createFramebuffer();i.bindFramebuffer(i.FRAMEBUFFER,o);const a=i.createTexture();i.bindTexture(i.TEXTURE_2D,a),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.NEAREST),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.NEAREST),i.texImage2D(i.TEXTURE_2D,0,i.RGBA,512,512,0,i.RGBA,i.UNSIGNED_BYTE,null);const h=i.createRenderbuffer();i.bindRenderbuffer(i.RENDERBUFFER,h),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,512,512),i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,a,0),i.framebufferRenderbuffer(i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,h);const c=[];for(let d=t.x;d<=e.x;d++)for(let s=t.y;s<=e.y;s++)for(let r=t.z;r<=e.z;r++)n.getBlock(d,s,r)!=u.AIR&&u.pushPickingVertices(c,d,s,r);const l=i.createBuffer();l.vertices=c.length/9,i.bindBuffer(i.ARRAY_BUFFER,l),i.bufferData(i.ARRAY_BUFFER,new Float32Array(c),i.STREAM_DRAW),i.bindTexture(i.TEXTURE_2D,this.texWhite),i.viewport(0,0,512,512),i.clearColor(1,1,1,1),i.clear(i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT),this.drawBuffer(l);const p=new Uint8Array(4);if(i.readPixels(s/i.viewportWidth*512,512*(1-r/i.viewportHeight),1,1,i.RGBA,i.UNSIGNED_BYTE,p),i.bindTexture(i.TEXTURE_2D,this.texTerrain),i.bindFramebuffer(i.FRAMEBUFFER,null),i.clearColor(.62,.81,1,1),i.deleteBuffer(l),i.deleteRenderbuffer(h),i.deleteTexture(a),i.deleteFramebuffer(o),255!=p[0]){let t;return 1==p[3]?t=new d(0,0,1):2==p[3]?t=new d(0,0,-1):3==p[3]?t=new d(0,-1,0):4==p[3]?t=new d(0,1,0):5==p[3]?t=new d(-1,0,0):6==p[3]&&(t=new d(1,0,0)),{x:p[0],y:p[1],z:p[2],n:t}}return!1}updateViewport(){const t=this.gl,e=this.canvas;e.clientWidth==t.viewportWidth&&e.clientHeight==t.viewportHeight||(t.viewportWidth=e.clientWidth,t.viewportHeight=e.clientHeight,e.width=e.clientWidth,e.height=e.clientHeight,this.setPerspective(this.fov,this.min,this.max))}loadShaders(){const t=this.gl,e=this.program=t.createProgram(),s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,"\n\tuniform mat4 uProjMatrix;\n\tuniform mat4 uViewMatrix;\n\tuniform mat4 uModelMatrix;\n\tattribute vec3 aPos;\n\tattribute vec4 aColor;\n\tattribute vec2 aTexCoord;\n\tvarying vec4 vColor;\n\tvarying vec2 vTexCoord;\n\tvoid main() {\n\t\tgl_Position = uProjMatrix * uViewMatrix * ( uModelMatrix * vec4( aPos, 1.0 ) );\n\t\tvColor = aColor;\n\t\tvTexCoord = aTexCoord;\n\t}\n"),t.compileShader(s),t.attachShader(e,s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(`Could not compile vertex shader!\n${t.getShaderInfoLog(s)}`);const r=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(r,"\n\tprecision highp float;\n\tuniform sampler2D uSampler;\n\tvarying vec4 vColor;\n\tvarying vec2 vTexCoord;\n\tvoid main() {\n\t\tvec4 color = texture2D( uSampler, vec2( vTexCoord.s, vTexCoord.t ) ) * vec4( vColor.rgb, 1.0 );\n\t\tif ( color.a < 0.1 ) discard;\n\t\tgl_FragColor = vec4( color.rgb, vColor.a );\n\t}\n"),t.compileShader(r),t.attachShader(e,r),!t.getShaderParameter(r,t.COMPILE_STATUS))throw new Error(`Could not compile fragment shader!\n${t.getShaderInfoLog(r)}`);if(t.linkProgram(e),!t.getProgramParameter(e,t.LINK_STATUS))throw new Error("Could not link the shader program!");t.useProgram(e),this.uProjMat=t.getUniformLocation(e,"uProjMatrix"),this.uViewMat=t.getUniformLocation(e,"uViewMatrix"),this.uModelMat=t.getUniformLocation(e,"uModelMatrix"),this.uSampler=t.getUniformLocation(e,"uSampler"),this.aPos=t.getAttribLocation(e,"aPos"),this.aColor=t.getAttribLocation(e,"aColor"),this.aTexCoord=t.getAttribLocation(e,"aTexCoord"),t.enableVertexAttribArray(this.aPos),t.enableVertexAttribArray(this.aColor),t.enableVertexAttribArray(this.aTexCoord)}setWorld(t,e){this.world=t,t.renderer=this,this.chunkSize=e;const s=this.chunks=[];for(let r=0;r<t.sx;r+=e)for(let i=0;i<t.sy;i+=e)for(let n=0;n<t.sz;n+=e)s.push({start:[r,i,n],end:[Math.min(t.sx,r+e),Math.min(t.sy,i+e),Math.min(t.sz,n+e)],dirty:!0})}onBlockChanged(t,e,s){const r=this.chunks;for(let i=0;i<r.length;i++)(t>=r[i].start[0]&&t<r[i].end[0]&&e>=r[i].start[1]&&e<r[i].end[1]&&s>=r[i].start[2]&&s<r[i].end[2]||t>=r[i].start[0]&&t<r[i].end[0]&&e>=r[i].start[1]&&e<r[i].end[1]&&(s>=r[i].end[2]||s==r[i].start[2]-1)||t>=r[i].start[0]&&t<r[i].end[0]&&s>=r[i].start[2]&&s<r[i].end[2]&&(e==r[i].end[1]||e==r[i].start[1]-1)||e>=r[i].start[1]&&e<r[i].end[1]&&s>=r[i].start[2]&&s<r[i].end[2]&&(t==r[i].end[0]||t==r[i].start[0]-1))&&(r[i].dirty=!0)}buildChunks(t){const e=this.gl,s=this.chunks,r=this.world;for(let i=0;i<s.length;i++){const n=s[i];if(n.dirty){const s=[],i={};for(let t=n.start[0]-1;t<n.end[0]+1;t++){i[t]={};for(let e=n.start[1]-1;e<n.end[1]+1;e++)for(let s=r.sz-1;s>=0&&(i[t][e]=s,r.getBlock(t,e,s).transparent);s--);}for(let t=n.start[0];t<n.end[0];t++)for(let e=n.start[1];e<n.end[1];e++)for(let o=n.start[2];o<n.end[2];o++)r.blocks[t][e][o]!=u.AIR&&u.pushVertices(s,r,i,t,e,o);n.buffer&&e.deleteBuffer(n.buffer);const o=n.buffer=e.createBuffer();o.vertices=s.length/9,e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,new Float32Array(s),e.STATIC_DRAW),n.dirty=!1,t--}if(0==t)break}}setPerspective(t,e,s,r){const i=this.gl;this.fov=t,this.min=s,this.max=r,o.perspective(this.projMatrix,t,e,s,r),i.uniformMatrix4fv(this.uProjMat,!1,this.projMatrix)}setCamera(t,e){const s=this.gl;this.camPos=t,o.identity(this.viewMatrix),o.rotateX(this.viewMatrix,this.viewMatrix,-e[0]-Math.PI/2),o.rotateZ(this.viewMatrix,this.viewMatrix,e[1]),o.rotateY(this.viewMatrix,this.viewMatrix,-e[2]),o.translate(this.viewMatrix,this.viewMatrix,[-t[0],-t[1],-t[2]]),s.uniformMatrix4fv(this.uViewMat,!1,this.viewMatrix)}drawBuffer(t){const e=this.gl;e.bindBuffer(e.ARRAY_BUFFER,t),e.vertexAttribPointer(this.aPos,3,e.FLOAT,!1,36,0),e.vertexAttribPointer(this.aColor,4,e.FLOAT,!1,36,20),e.vertexAttribPointer(this.aTexCoord,2,e.FLOAT,!1,36,12),e.drawArrays(e.TRIANGLES,0,t.vertices)}loadPlayerHeadModel(){const t=this.gl,e=[-.25,-.25,.25,8/64,0,1,1,1,1,.25,-.25,.25,.25,0,1,1,1,1,.25,.25,.25,.25,.25,1,1,1,1,.25,.25,.25,.25,.25,1,1,1,1,-.25,.25,.25,8/64,.25,1,1,1,1,-.25,-.25,.25,8/64,0,1,1,1,1,-.25,-.25,-.25,.25,0,1,1,1,1,-.25,.25,-.25,.25,.25,1,1,1,1,.25,.25,-.25,.375,.25,1,1,1,1,.25,.25,-.25,.375,.25,1,1,1,1,.25,-.25,-.25,.375,0,1,1,1,1,-.25,-.25,-.25,.25,0,1,1,1,1,-.25,-.25,.25,8/64,.25,1,1,1,1,-.25,-.25,-.25,8/64,.5,1,1,1,1,.25,-.25,-.25,.25,.5,1,1,1,1,.25,-.25,-.25,.25,.5,1,1,1,1,.25,-.25,.25,.25,.25,1,1,1,1,-.25,-.25,.25,8/64,.25,1,1,1,1,-.25,.25,.25,.375,.25,1,1,1,1,.25,.25,.25,.5,.25,1,1,1,1,.25,.25,-.25,.5,.5,1,1,1,1,.25,.25,-.25,.5,.5,1,1,1,1,-.25,.25,-.25,.375,.5,1,1,1,1,-.25,.25,.25,.375,.25,1,1,1,1,-.25,-.25,.25,.25,.25,1,1,1,1,-.25,.25,.25,.375,.25,1,1,1,1,-.25,.25,-.25,.375,.5,1,1,1,1,-.25,.25,-.25,.375,.5,1,1,1,1,-.25,-.25,-.25,.25,.5,1,1,1,1,-.25,-.25,.25,.25,.25,1,1,1,1,.25,-.25,.25,0,.25,1,1,1,1,.25,-.25,-.25,0,.5,1,1,1,1,.25,.25,-.25,8/64,.5,1,1,1,1,.25,.25,-.25,8/64,.5,1,1,1,1,.25,.25,.25,8/64,.25,1,1,1,1,.25,-.25,.25,0,.25,1,1,1,1],s=this.playerHead=t.createBuffer();s.vertices=e.length/9,t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.DYNAMIC_DRAW)}loadPlayerBodyModel(){const t=this.gl;let e=[-.3,-.125,1.45,20/64,.5,1,1,1,1,.3,-.125,1.45,28/64,.5,1,1,1,1,.3,.125,1.45,28/64,.625,1,1,1,1,.3,.125,1.45,28/64,.625,1,1,1,1,-.3,.125,1.45,20/64,.625,1,1,1,1,-.3,-.125,1.45,20/64,.5,1,1,1,1,-.3,-.125,.73,28/64,.5,1,1,1,1,-.3,.125,.73,28/64,.625,1,1,1,1,.3,.125,.73,36/64,.625,1,1,1,1,.3,.125,.73,36/64,.625,1,1,1,1,.3,-.125,.73,36/64,.5,1,1,1,1,-.3,-.125,.73,28/64,.5,1,1,1,1,-.3,-.125,1.45,20/64,.625,1,1,1,1,-.3,-.125,.73,20/64,1,1,1,1,1,.3,-.125,.73,28/64,1,1,1,1,1,.3,-.125,.73,28/64,1,1,1,1,1,.3,-.125,1.45,28/64,.625,1,1,1,1,-.3,-.125,1.45,20/64,.625,1,1,1,1,-.3,.125,1.45,.625,.625,1,1,1,1,.3,.125,1.45,.5,.625,1,1,1,1,.3,.125,.73,.5,1,1,1,1,1,.3,.125,.73,.5,1,1,1,1,1,-.3,.125,.73,.625,1,1,1,1,1,-.3,.125,1.45,.625,.625,1,1,1,1,-.3,-.125,1.45,.25,.625,1,1,1,1,-.3,.125,1.45,20/64,.625,1,1,1,1,-.3,.125,.73,20/64,1,1,1,1,1,-.3,.125,.73,20/64,1,1,1,1,1,-.3,-.125,.73,.25,1,1,1,1,1,-.3,-.125,1.45,.25,.625,1,1,1,1,.3,-.125,1.45,28/64,.625,1,1,1,1,.3,-.125,.73,28/64,1,1,1,1,1,.3,.125,.73,.5,1,1,1,1,1,.3,.125,.73,.5,1,1,1,1,1,.3,.125,1.45,.5,.625,1,1,1,1,.3,-.125,1.45,28/64,.625,1,1,1,1],s=this.playerBody=t.createBuffer();s.vertices=e.length/9,t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.DYNAMIC_DRAW),e=[.3,-.125,.05,44/64,.5,1,1,1,1,.55,-.125,.05,.75,.5,1,1,1,1,.55,.125,.05,.75,.625,1,1,1,1,.55,.125,.05,.75,.625,1,1,1,1,.3,.125,.05,44/64,.625,1,1,1,1,.3,-.125,.05,44/64,.5,1,1,1,1,.3,-.125,-.67,.75,.5,1,1,1,1,.3,.125,-.67,.75,.625,1,1,1,1,.55,.125,-.67,52/64,.625,1,1,1,1,.55,.125,-.67,52/64,.625,1,1,1,1,.55,-.125,-.67,52/64,.5,1,1,1,1,.3,-.125,-.67,.75,.5,1,1,1,1,.3,-.125,.05,.75,.625,1,1,1,1,.3,-.125,-.67,.75,1,1,1,1,1,.55,-.125,-.67,44/64,1,1,1,1,1,.55,-.125,-.67,44/64,1,1,1,1,1,.55,-.125,.05,44/64,.625,1,1,1,1,.3,-.125,.05,.75,.625,1,1,1,1,.3,.125,.05,52/64,.625,1,1,1,1,.55,.125,.05,.875,.625,1,1,1,1,.55,.125,-.67,.875,1,1,1,1,1,.55,.125,-.67,.875,1,1,1,1,1,.3,.125,-.67,52/64,1,1,1,1,1,.3,.125,.05,52/64,.625,1,1,1,1,.3,-.125,.05,.75,.625,1,1,1,1,.3,.125,.05,52/64,.625,1,1,1,1,.3,.125,-.67,52/64,1,1,1,1,1,.3,.125,-.67,52/64,1,1,1,1,1,.3,-.125,-.67,.75,1,1,1,1,1,.3,-.125,.05,.75,.625,1,1,1,1,.55,-.125,.05,44/64,.625,1,1,1,1,.55,-.125,-.67,44/64,1,1,1,1,1,.55,.125,-.67,.625,1,1,1,1,1,.55,.125,-.67,.625,1,1,1,1,1,.55,.125,.05,.625,.625,1,1,1,1,.55,-.125,.05,44/64,.625,1,1,1,1],s=this.playerLeftArm=t.createBuffer(),s.vertices=e.length/9,t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.DYNAMIC_DRAW),e=[-.55,-.125,.05,44/64,.5,1,1,1,1,-.3,-.125,.05,.75,.5,1,1,1,1,-.3,.125,.05,.75,.625,1,1,1,1,-.3,.125,.05,.75,.625,1,1,1,1,-.55,.125,.05,44/64,.625,1,1,1,1,-.55,-.125,.05,44/64,.5,1,1,1,1,-.55,-.125,-.67,52/64,.5,1,1,1,1,-.55,.125,-.67,52/64,.625,1,1,1,1,-.3,.125,-.67,.75,.625,1,1,1,1,-.3,.125,-.67,.75,.625,1,1,1,1,-.3,-.125,-.67,.75,.5,1,1,1,1,-.55,-.125,-.67,52/64,.5,1,1,1,1,-.55,-.125,.05,44/64,.625,1,1,1,1,-.55,-.125,-.67,44/64,1,1,1,1,1,-.3,-.125,-.67,.75,1,1,1,1,1,-.3,-.125,-.67,.75,1,1,1,1,1,-.3,-.125,.05,.75,.625,1,1,1,1,-.55,-.125,.05,44/64,.625,1,1,1,1,-.55,.125,.05,.875,.625,1,1,1,1,-.3,.125,.05,52/64,.625,1,1,1,1,-.3,.125,-.67,52/64,1,1,1,1,1,-.3,.125,-.67,52/64,1,1,1,1,1,-.55,.125,-.67,.875,1,1,1,1,1,-.55,.125,.05,.875,.625,1,1,1,1,-.55,-.125,.05,44/64,.625,1,1,1,1,-.55,.125,.05,.625,.625,1,1,1,1,-.55,.125,-.67,.625,1,1,1,1,1,-.55,.125,-.67,.625,1,1,1,1,1,-.55,-.125,-.67,44/64,1,1,1,1,1,-.55,-.125,.05,44/64,.625,1,1,1,1,-.3,-.125,.05,.75,.625,1,1,1,1,-.3,-.125,-.67,.75,1,1,1,1,1,-.3,.125,-.67,52/64,1,1,1,1,1,-.3,.125,-.67,52/64,1,1,1,1,1,-.3,.125,.05,52/64,.625,1,1,1,1,-.3,-.125,.05,.75,.625,1,1,1,1],s=this.playerRightArm=t.createBuffer(),s.vertices=e.length/9,t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.DYNAMIC_DRAW),e=[.01,-.125,0,4/64,.5,1,1,1,1,.3,-.125,0,8/64,.5,1,1,1,1,.3,.125,0,8/64,.625,1,1,1,1,.3,.125,0,8/64,.625,1,1,1,1,.01,.125,0,4/64,.625,1,1,1,1,.01,-.125,0,4/64,.5,1,1,1,1,.01,-.125,-.73,8/64,.5,1,1,1,1,.01,.125,-.73,8/64,.625,1,1,1,1,.3,.125,-.73,12/64,.625,1,1,1,1,.3,.125,-.73,12/64,.625,1,1,1,1,.3,-.125,-.73,12/64,.5,1,1,1,1,.01,-.125,-.73,8/64,.5,1,1,1,1,.01,-.125,0,4/64,.625,1,1,1,1,.01,-.125,-.73,4/64,1,1,1,1,1,.3,-.125,-.73,8/64,1,1,1,1,1,.3,-.125,-.73,8/64,1,1,1,1,1,.3,-.125,0,8/64,.625,1,1,1,1,.01,-.125,0,4/64,.625,1,1,1,1,.01,.125,0,12/64,.625,1,1,1,1,.3,.125,0,.25,.625,1,1,1,1,.3,.125,-.73,.25,1,1,1,1,1,.3,.125,-.73,.25,1,1,1,1,1,.01,.125,-.73,12/64,1,1,1,1,1,.01,.125,0,12/64,.625,1,1,1,1,.01,-.125,0,8/64,.625,1,1,1,1,.01,.125,0,12/64,.625,1,1,1,1,.01,.125,-.73,12/64,1,1,1,1,1,.01,.125,-.73,12/64,1,1,1,1,1,.01,-.125,-.73,8/64,1,1,1,1,1,.01,-.125,0,8/64,.625,1,1,1,1,.3,-.125,0,4/64,.625,1,1,1,1,.3,-.125,-.73,4/64,1,1,1,1,1,.3,.125,-.73,0,1,1,1,1,1,.3,.125,-.73,0,1,1,1,1,1,.3,.125,0,0,.625,1,1,1,1,.3,-.125,0,4/64,.625,1,1,1,1],s=this.playerLeftLeg=t.createBuffer(),s.vertices=e.length/9,t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.DYNAMIC_DRAW),e=[-.3,-.125,0,4/64,.5,1,1,1,1,-.01,-.125,0,8/64,.5,1,1,1,1,-.01,.125,0,8/64,.625,1,1,1,1,-.01,.125,0,8/64,.625,1,1,1,1,-.3,.125,0,4/64,.625,1,1,1,1,-.3,-.125,0,4/64,.5,1,1,1,1,-.3,-.125,-.73,8/64,.5,1,1,1,1,-.3,.125,-.73,8/64,.625,1,1,1,1,-.01,.125,-.73,12/64,.625,1,1,1,1,-.01,.125,-.73,12/64,.625,1,1,1,1,-.01,-.125,-.73,12/64,.5,1,1,1,1,-.3,-.125,-.73,8/64,.5,1,1,1,1,-.3,-.125,0,4/64,.625,1,1,1,1,-.3,-.125,-.73,4/64,1,1,1,1,1,-.01,-.125,-.73,8/64,1,1,1,1,1,-.01,-.125,-.73,8/64,1,1,1,1,1,-.01,-.125,0,8/64,.625,1,1,1,1,-.3,-.125,0,4/64,.625,1,1,1,1,-.3,.125,0,.25,.625,1,1,1,1,-.01,.125,0,12/64,.625,1,1,1,1,-.01,.125,-.73,12/64,1,1,1,1,1,-.01,.125,-.73,12/64,1,1,1,1,1,-.3,.125,-.73,.25,1,1,1,1,1,-.3,.125,0,.25,.625,1,1,1,1,-.3,-.125,0,4/64,.625,1,1,1,1,-.3,.125,0,0,.625,1,1,1,1,-.3,.125,-.73,0,1,1,1,1,1,-.3,.125,-.73,0,1,1,1,1,1,-.3,-.125,-.73,4/64,1,1,1,1,1,-.3,-.125,0,4/64,.625,1,1,1,1,-.01,-.125,0,8/64,.625,1,1,1,1,-.01,-.125,-.73,8/64,1,1,1,1,1,-.01,.125,-.73,12/64,1,1,1,1,1,-.01,.125,-.73,12/64,1,1,1,1,1,-.01,.125,0,12/64,.625,1,1,1,1,-.01,-.125,0,8/64,.625,1,1,1,1],s=this.playerRightLeg=t.createBuffer(),s.vertices=e.length/9,t.bindBuffer(t.ARRAY_BUFFER,s),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e),t.DYNAMIC_DRAW)}cleanup(){const t=this.gl;if(t.deleteProgram(this.program),t.deleteTexture(this.texWhite),t.deleteTexture(this.texPlayer),t.deleteTexture(this.texTerrain),this.playerHead&&t.deleteBuffer(this.playerHead),this.playerBody&&t.deleteBuffer(this.playerBody),this.playerLeftArm&&t.deleteBuffer(this.playerLeftArm),this.playerRightArm&&t.deleteBuffer(this.playerRightArm),this.playerLeftLeg&&t.deleteBuffer(this.playerLeftLeg),this.playerRightLeg&&t.deleteBuffer(this.playerRightLeg),this.chunks)for(const e of this.chunks)e.buffer&&t.deleteBuffer(e.buffer);if(this.world&&this.world.players)for(const e of Object.values(this.world.players))e.nametag&&(t.deleteTexture(e.nametag.texture),t.deleteBuffer(e.nametag.model),delete e.nametag);this.textCanvas&&this.textCanvas.parentNode&&this.textCanvas.parentNode.removeChild(this.textCanvas)}handleContextLost(){console.log("WebGL context lost"),this.contextLost=!0}handleContextRestored(){console.log("WebGL context restored"),this.contextLost=!1,this.loadShaders(),this.loadPlayerHeadModel(),this.loadPlayerBodyModel(),this.chunks&&this.chunks.forEach((t=>t.dirty=!0))}updateFrustumPlanes(){const t=o.create();o.multiply(t,this.projMatrix,this.viewMatrix),h.set(this.frustumPlanes[0],t[3]+t[0],t[7]+t[4],t[11]+t[8],t[15]+t[12]),h.normalize(this.frustumPlanes[0],this.frustumPlanes[0]),h.set(this.frustumPlanes[1],t[3]-t[0],t[7]-t[4],t[11]-t[8],t[15]-t[12]),h.normalize(this.frustumPlanes[1],this.frustumPlanes[1]),h.set(this.frustumPlanes[2],t[3]+t[1],t[7]+t[5],t[11]+t[9],t[15]+t[13]),h.normalize(this.frustumPlanes[2],this.frustumPlanes[2]),h.set(this.frustumPlanes[3],t[3]-t[1],t[7]-t[5],t[11]-t[9],t[15]-t[13]),h.normalize(this.frustumPlanes[3],this.frustumPlanes[3]),h.set(this.frustumPlanes[4],t[3]+t[2],t[7]+t[6],t[11]+t[10],t[15]+t[14]),h.normalize(this.frustumPlanes[4],this.frustumPlanes[4]),h.set(this.frustumPlanes[5],t[3]-t[2],t[7]-t[6],t[11]-t[10],t[15]-t[14]),h.normalize(this.frustumPlanes[5],this.frustumPlanes[5])}isChunkInFrustum(t){const e=t.start,s=t.end;for(let r=0;r<6;r++){const t=this.frustumPlanes[r];if(h.dot(t,h.fromValues(e[0],e[1],e[2],1))<0&&h.dot(t,h.fromValues(s[0],e[1],e[2],1))<0&&h.dot(t,h.fromValues(e[0],s[1],e[2],1))<0&&h.dot(t,h.fromValues(s[0],s[1],e[2],1))<0&&h.dot(t,h.fromValues(e[0],e[1],s[2],1))<0&&h.dot(t,h.fromValues(s[0],e[1],s[2],1))<0&&h.dot(t,h.fromValues(e[0],s[1],s[2],1))<0&&h.dot(t,h.fromValues(s[0],s[1],s[2],1))<0)return!1}return!0}}class R{constructor(){this.lastStep=-1}setWorld(t){this.world=t}simulate(){const t=this.world,e=t.blocks,s=Math.floor((new Date).getTime()/100);if(s!==this.lastStep){if(this.lastStep=s,s%1==0)for(let s=0;s<t.sx;s++)for(let r=0;r<t.sy;r++)for(let i=0;i<t.sz;i++)e[s][r][i].gravity&&i>0&&e[s][r][i-1]===u.AIR&&(t.setBlock(s,r,i-1,e[s][r][i]),t.setBlock(s,r,i,u.AIR));if(s%10==0){const s={};for(let r=0;r<t.sx;r++)for(let i=0;i<t.sy;i++)for(let n=0;n<t.sz;n++){const o=e[r][i][n];o.fluid&&null==s[`${r},${i},${n}`]&&(r>0&&e[r-1][i][n]===u.AIR&&(t.setBlock(r-1,i,n,o),s[`${r-1},${i},${n}`]=!0),r<t.sx-1&&e[r+1][i][n]===u.AIR&&(t.setBlock(r+1,i,n,o),s[`${r+1},${i},${n}`]=!0),i>0&&e[r][i-1][n]===u.AIR&&(t.setBlock(r,i-1,n,o),s[`${r},${i-1},${n}`]=!0),i<t.sy-1&&e[r][i+1][n]===u.AIR&&(t.setBlock(r,i+1,n,o),s[`${r},${i+1},${n}`]=!0))}}}}}void 0!==t&&(t.Physics=R);const _=1,B=2,P=3;class C{update(){this.pos||(this.pos=new d(0,0,0)),this.world;const t=this.velocity,e=this.pos,s=new d(Math.floor(e.x),Math.floor(e.y),Math.floor(e.z));if(null!=this.lastUpdate){const r=((new Date).getTime()-this.lastUpdate)/1e3;this.dragging&&(this.angles[0]+=30*(this.targetPitch-this.angles[0])*r,this.angles[1]+=30*(this.targetYaw-this.angles[1])*r,this.angles[0]<-Math.PI/2&&(this.angles[0]=-Math.PI/2),this.angles[0]>Math.PI/2&&(this.angles[0]=Math.PI/2)),this.falling&&(t.z+=-.5),this.keys[" "]&&!this.falling&&(t.z=8);let i=new d(0,0,0);this.falling||(this.keys.w&&(i.x+=Math.cos(Math.PI/2-this.angles[1]),i.y+=Math.sin(Math.PI/2-this.angles[1])),this.keys.s&&(i.x+=Math.cos(Math.PI+Math.PI/2-this.angles[1]),i.y+=Math.sin(Math.PI+Math.PI/2-this.angles[1])),this.keys.a&&(i.x+=Math.cos(Math.PI/2+Math.PI/2-this.angles[1]),i.y+=Math.sin(Math.PI/2+Math.PI/2-this.angles[1])),this.keys.d&&(i.x+=Math.cos(-Math.PI/2+Math.PI/2-this.angles[1]),i.y+=Math.sin(-Math.PI/2+Math.PI/2-this.angles[1]))),i.length()>0?(i=i.normal(),t.x=4*i.x,t.y=4*i.y):(t.x/=this.falling?1.01:1.5,t.y/=this.falling?1.01:1.5),this.pos=this.resolveCollision(e,s,t.mul(r))}this.lastUpdate=(new Date).getTime()}}C.prototype.setWorld=function(t){this.world=t,this.world.localPlayer=this,this.pos=t.spawnPoint,this.velocity=new d(0,0,0),this.angles=[0,Math.PI,0],this.falling=!1,this.keys={},this.buildMaterial=u.DIRT,this.eventHandlers={}},C.prototype.setClient=function(t){this.client=t},C.prototype.setInputCanvas=function(t){const e=this.canvas=document.getElementById(t);document.onkeydown=t=>{if("INPUT"!==t.target.tagName)return this.onKeyEvent(t.keyCode,!0),!1},document.onkeyup=t=>{if("INPUT"!==t.target.tagName)return this.onKeyEvent(t.keyCode,!1),!1},e.onmousedown=t=>(this.onMouseEvent(t.clientX,t.clientY,_,3===t.which),!1),e.onmouseup=t=>(this.onMouseEvent(t.clientX,t.clientY,B,3===t.which),!1),e.onmousemove=t=>(this.onMouseEvent(t.clientX,t.clientY,P,3===t.which),!1)},C.prototype.setMaterialSelector=function(t){const e=document.getElementById(t).getElementsByTagName("tr")[0];let s=0;this.prevSelector=null;for(const r in u)if("object"==typeof u[r]&&u[r].spawnable){const t=document.createElement("td");t.style.backgroundPosition=`${s}px 0px`,t.material=u[r],t.onclick=function(){this.style.opacity="1.0",this.prevSelector&&(this.prevSelector.style.opacity=null),this.prevSelector=this,this.buildMaterial=this.material}.bind(this),"DIRT"===r&&(this.prevSelector=t,t.style.opacity="1.0"),e.appendChild(t),s-=70}},C.prototype.on=function(t,e){this.eventHandlers[t]=e},C.prototype.onKeyEvent=function(t,e){const s=String.fromCharCode(t).toLowerCase();this.keys[s]=e,this.keys[t]=e,!e&&"t"===s&&this.eventHandlers.openChat&&this.eventHandlers.openChat()},C.prototype.onMouseEvent=function(t,e,s,r){s===_?(this.dragStart={x:t,y:e},this.mouseDown=!0,this.yawStart=this.targetYaw=this.angles[1],this.pitchStart=this.targetPitch=this.angles[0]):s===B?(Math.abs(this.dragStart.x-t)+Math.abs(this.dragStart.y-e)<4&&this.doBlockAction(t,e,!r),this.dragging=!1,this.mouseDown=!1,this.canvas.style.cursor="default"):s===P&&this.mouseDown&&(this.dragging=!0,this.targetPitch=this.pitchStart-(e-this.dragStart.y)/200,this.targetYaw=this.yawStart+(t-this.dragStart.x)/200,this.canvas.style.cursor="move")},C.prototype.doBlockAction=function(t,e,s){const r=new d(Math.floor(this.pos.x),Math.floor(this.pos.y),Math.floor(this.pos.z)),i=this.canvas.renderer.pickAt(new d(r.x-4,r.y-4,r.z-4),new d(r.x+4,r.y+4,r.z+4),t,e);if(!1!==i){const t=this.client?this.client:this.world;s?t.setBlock(i.x,i.y,i.z,u.AIR):t.setBlock(i.x+i.n.x,i.y+i.n.y,i.z+i.n.z,this.buildMaterial)}},C.prototype.getEyePos=function(){return this.pos.add(new d(0,0,1.7))},C.prototype.update=function(){this.pos||(this.pos=new d(0,0,0)),this.world;const t=this.velocity,e=this.pos,s=new d(Math.floor(e.x),Math.floor(e.y),Math.floor(e.z));if(null!=this.lastUpdate){const r=((new Date).getTime()-this.lastUpdate)/1e3;this.dragging&&(this.angles[0]+=30*(this.targetPitch-this.angles[0])*r,this.angles[1]+=30*(this.targetYaw-this.angles[1])*r,this.angles[0]<-Math.PI/2&&(this.angles[0]=-Math.PI/2),this.angles[0]>Math.PI/2&&(this.angles[0]=Math.PI/2)),this.falling&&(t.z+=-.5),this.keys[" "]&&!this.falling&&(t.z=8);let i=new d(0,0,0);this.falling||(this.keys.w&&(i.x+=Math.cos(Math.PI/2-this.angles[1]),i.y+=Math.sin(Math.PI/2-this.angles[1])),this.keys.s&&(i.x+=Math.cos(Math.PI+Math.PI/2-this.angles[1]),i.y+=Math.sin(Math.PI+Math.PI/2-this.angles[1])),this.keys.a&&(i.x+=Math.cos(Math.PI/2+Math.PI/2-this.angles[1]),i.y+=Math.sin(Math.PI/2+Math.PI/2-this.angles[1])),this.keys.d&&(i.x+=Math.cos(-Math.PI/2+Math.PI/2-this.angles[1]),i.y+=Math.sin(-Math.PI/2+Math.PI/2-this.angles[1]))),i.length()>0?(i=i.normal(),t.x=4*i.x,t.y=4*i.y):(t.x/=this.falling?1.01:1.5,t.y/=this.falling?1.01:1.5),this.pos=this.resolveCollision(e,s,t.mul(r))}this.lastUpdate=(new Date).getTime()},C.prototype.resolveCollision=function(t,e,s){const r=this.world,i={x:t.x+s.x,y:t.y+s.y,size:.25};let n=[];for(let c=e.x-1;c<=e.x+1;c++)for(let t=e.y-1;t<=e.y+1;t++)for(let s=e.z;s<=e.z+1;s++)r.getBlock(c,t,s)!==u.AIR&&(r.getBlock(c-1,t,s)===u.AIR&&n.push({x:c,dir:-1,y1:t,y2:t+1}),r.getBlock(c+1,t,s)===u.AIR&&n.push({x:c+1,dir:1,y1:t,y2:t+1}),r.getBlock(c,t-1,s)===u.AIR&&n.push({y:t,dir:-1,x1:c,x2:c+1}),r.getBlock(c,t+1,s)===u.AIR&&n.push({y:t+1,dir:1,x1:c,x2:c+1}));for(const c of n)p(c,i)&&(null!=c.x&&s.x*c.dir<0?(t.x=c.x+i.size/2*(s.x>0?-1:1),s.x=0):null!=c.y&&s.y*c.dir<0&&(t.y=c.y+i.size/2*(s.y>0?-1:1),s.y=0));const o={x1:t.x+s.x-.125,y1:t.y+s.y-.125,x2:t.x+s.x+.125,y2:t.y+s.y+.125},a=Math.floor(t.z+s.z),h=Math.floor(t.z+1.7+1.1*s.z);n=[];for(let c=e.x-1;c<=e.x+1;c++)for(let t=e.y-1;t<=e.y+1;t++)r.getBlock(c,t,a)!==u.AIR&&n.push({z:a+1,dir:1,x1:c,y1:t,x2:c+1,y2:t+1}),r.getBlock(c,t,h)!==u.AIR&&n.push({z:h,dir:-1,x1:c,y1:t,x2:c+1,y2:t+1});this.falling=!0;for(const c of n)if(f(c,o)&&s.z*c.dir<0){s.z<0?(this.falling=!1,t.z=c.z,s.z=0,this.velocity.z=0):(t.z=c.z-1.8,s.z=0,this.velocity.z=0);break}return t.add(s)};class I{constructor(t){this.io=t,this.eventHandlers={},this.kicked=!1}connect(t,e){this.socket=this.io.connect(t,{reconnect:!1}),this.nickname=e,this.socket.on("connect",(()=>this.onConnection())),this.socket.on("disconnect",(()=>this.onDisconnection())),this.socket.on("world",(t=>this.onWorld(t))),this.socket.on("spawn",(t=>this.onSpawn(t))),this.socket.on("setblock",(t=>this.onBlockUpdate(t))),this.socket.on("msg",(t=>this.onMessage(t))),this.socket.on("kick",(t=>this.onKick(t))),this.socket.on("join",(t=>this.onPlayerJoin(t))),this.socket.on("leave",(t=>this.onPlayerLeave(t))),this.socket.on("player",(t=>this.onPlayerUpdate(t))),this.socket.on("setpos",(t=>this.onPlayerSetPos(t)))}setBlock(t,e,s,r){this.socket.emit("setblock",{x:t,y:e,z:s,mat:r.id})}sendMessage(t){this.socket.emit("chat",{msg:t})}updatePlayer(){if(!this.world||!this.world.localPlayer)return;const t=this.world.localPlayer;this.socket.emit("player",{x:t.pos.x,y:t.pos.y,z:t.pos.z,pitch:t.angles[0],yaw:t.angles[1]})}on(t,e){this.eventHandlers[t]=e}onConnection(){this.eventHandlers.connect&&this.eventHandlers.connect(),this.socket.emit("nickname",{nickname:this.nickname})}onDisconnection(){this.eventHandlers.disconnect&&this.eventHandlers.disconnect(this.kicked)}onWorld(t){console.log("Received world data:",t),console.log("Creating world with dimensions:",t.sx,t.sy,t.sz),this.world=new World(t.sx,t.sy,t.sz),this.world.createFromString(t.blocks),console.log("World created successfully"),this.eventHandlers.world&&this.eventHandlers.world(this.world)}onSpawn(t){this.world.spawnPoint=new d(t.x,t.y,t.z),this.eventHandlers.spawn&&this.eventHandlers.spawn()}onBlockUpdate(t){const e=BLOCK.fromId(t.mat);this.eventHandlers.block&&this.eventHandlers.block(t.x,t.y,t.z,this.world.blocks[t.x][t.y][t.z],e),this.world.setBlock(t.x,t.y,t.z,e)}onMessage(t){"chat"===t.type?this.eventHandlers.chat&&this.eventHandlers.chat(t.user,t.msg):"generic"===t.type&&this.eventHandlers.message&&this.eventHandlers.message(t.msg)}onKick(t){this.kicked=!0,this.eventHandlers.kick&&this.eventHandlers.kick(t.msg)}onPlayerJoin(t){t.moving=!1,t.aniframe=0,this.world.players[t.nick]=t}onPlayerLeave(t){this.world.players[t.nick].nametag&&(this.world.renderer.gl.deleteBuffer(this.world.players[t.nick].nametag.model),this.world.renderer.gl.deleteTexture(this.world.players[t.nick].nametag.texture)),delete this.world.players[t.nick]}onPlayerUpdate(t){if(!this.world)return;const e=this.world.players[t.nick];(Math.abs(t.x-e.x)>.1||Math.abs(t.y-e.y)>.1||Math.abs(t.z-e.z)>.1)&&(e.moving=!0),e.x=t.x,e.y=t.y,e.z=t.z,e.pitch=t.pitch,e.yaw=t.yaw,setTimeout((()=>{e.moving=!1}),100)}onPlayerSetPos(t){this.world.localPlayer.pos=new d(t.x,t.y,t.z),this.world.localPlayer.velocity=new d(0,0,0)}}function S(t,e){const s=require("express"),r=s(),i=require("http").Server(r);r.use(s.static(".")),this.io=t(i),this.eventHandlers={},this.activeNicknames={},this.activeAddresses={},this.maxSlots=e,this.usedSlots=0,this.oneUserPerIp=!0,this.io.sockets.on("connection",(t=>this.onConnection(t))),i.listen(3e3,(()=>{}))}function N(t){return(t%=2*Math.PI)<0&&(t=2*Math.PI+t),t}S.prototype.setWorld=function(t){this.world=t},S.prototype.setLogger=function(t){this.log=t},S.prototype.setOneUserPerIp=function(t){this.oneUserPerIp=t},S.prototype.on=function(t,e){this.eventHandlers[t]=e},S.prototype.sendMessage=function(t,e){(e||this.io.sockets).emit("msg",{type:"generic",msg:t})},S.prototype.broadcastMessage=function(t,e){e.broadcast.emit("msg",{type:"generic",msg:t})},S.prototype.kick=function(t,e){this.log&&this.log(`Client ${this.getIp(t)} was kicked (${e}).`),null!=t._nickname&&this.sendMessage(`${t._nickname} was kicked (${e}).`),t.emit("kick",{msg:e}),t.disconnect()},S.prototype.setPos=function(t,e,s,r){t.emit("setpos",{x:e,y:s,z:r})},S.prototype.findPlayerByName=function(t){for(const e in this.world.players)if(e.toLowerCase().includes(t.toLowerCase()))return this.world.players[e];return null},S.prototype.onConnection=function(t){this.log&&this.log(`Client ${this.getIp(t)} connected to the server.`),null==this.maxSlots||this.usedSlots!==this.maxSlots?this.activeAddresses[this.getIp(t)]&&this.oneUserPerIp?this.kick(t,"Multiple clients connecting from the same IP address!"):(this.activeAddresses[this.getIp(t)]=!0,this.usedSlots++,t.on("nickname",(e=>this.onNickname(t,e))),t.on("setblock",(e=>this.onBlockUpdate(t,e))),t.on("chat",(e=>this.onChatMessage(t,e))),t.on("player",(e=>this.onPlayerUpdate(t,e))),t.on("disconnect",(()=>this.onDisconnect(t)))):this.kick(t,"The server is full!")},S.prototype.onNickname=function(t,e){if(0===e.nickname.length||e.nickname.length>15)return!1;if(null==t._nickname){const s=this.sanitiseInput(e.nickname);for(const e in this.activeNicknames)if(e.toLowerCase()===s.toLowerCase())return void this.kick(t,"That username is already in use!");this.log&&this.log(`Client ${this.getIp(t)} is now known as ${s}.`),this.eventHandlers.join&&this.eventHandlers.join(t,s),this.activeNicknames[e.nickname]=!0,t._nickname=s;const r=this.world;t.emit("world",{sx:r.sx,sy:r.sy,sz:r.sz,blocks:r.toNetworkString()}),t.emit("spawn",{x:r.spawnPoint.x,y:r.spawnPoint.y,z:r.spawnPoint.z});for(const e in this.world.players){const s=this.world.players[e];t.emit("join",{nick:e,x:s.x,y:s.y,z:s.z,pitch:s.pitch,yaw:s.yaw})}t.broadcast.emit("join",{nick:s,x:r.spawnPoint.x,y:r.spawnPoint.y,z:r.spawnPoint.z,pitch:0,yaw:0}),r.players[s]={socket:t,nick:s,lastBlockCheck:+new Date,blocks:0,x:r.spawnPoint.x,y:r.spawnPoint.y,z:r.spawnPoint.z,pitch:0,yaw:0}}},S.prototype.onBlockUpdate=function(t,e){const s=this.world;if("number"!=typeof e.x||"number"!=typeof e.y||"number"!=typeof e.z||"number"!=typeof e.mat)return!1;if(e.x<0||e.y<0||e.z<0||e.x>=s.sx||e.y>=s.sy||e.z>=s.sz)return!1;if(Math.sqrt((e.x-s.spawnPoint.x)**2+(e.y-s.spawnPoint.y)**2+(e.z-s.spawnPoint.z)**2)<10)return!1;const r=BLOCK.fromId(e.mat);if(null==r||!r.spawnable&&0!==e.mat)return!1;if(null!=t._nickname)try{s.setBlock(e.x,e.y,e.z,r);const i=this.world.players[t._nickname];if(i.blocks++,+new Date>i.lastBlockCheck+100){if(i.blocks>5)return void this.kick(t,"Block spamming.");i.lastBlockCheck=+new Date,i.blocks=0}this.io.sockets.emit("setblock",{x:e.x,y:e.y,z:e.z,mat:e.mat})}catch(i){console.log(`Error setting block at ( ${e.x}, ${e.y}, ${e.z} ): ${i}`)}},S.prototype.onChatMessage=function(t,e){if("string"!=typeof e.msg||0===e.msg.trim().length||e.msg.length>100)return!1;const s=this.sanitiseInput(e.msg);if(null!=t._nickname){this.log&&this.log(`<${t._nickname}> ${s}`);let e=!1;this.eventHandlers.chat&&(e=this.eventHandlers.chat(t,t._nickname,s)),e||this.io.sockets.emit("msg",{type:"chat",user:t._nickname,msg:s})}},S.prototype.onPlayerUpdate=function(t,e){if("number"!=typeof e.x||"number"!=typeof e.y||"number"!=typeof e.z)return!1;if("number"!=typeof e.pitch||"number"!=typeof e.yaw)return!1;if(null!=t._nickname){const s=this.world.players[t._nickname];s.x=e.x,s.y=e.y,s.z=e.z,s.pitch=e.pitch,s.yaw=e.yaw;for(const e in this.world.players){const r=this.world.players[e];if(r.socket===t)continue;const i=Math.PI+Math.atan2(r.y-s.y,r.x-s.x),n=Math.PI-r.yaw-Math.PI/2;Math.abs(N(n)-N(i))<Math.PI/2&&r.socket.volatile.emit("player",{nick:t._nickname,x:s.x,y:s.y,z:s.z,pitch:s.pitch,yaw:s.yaw})}}},S.prototype.onDisconnect=function(t){this.log&&this.log(`Client ${this.getIp(t)} disconnected.`),this.usedSlots--,delete this.activeAddresses[this.getIp(t)],null!=t._nickname&&(delete this.activeNicknames[t._nickname],delete this.world.players[t._nickname],t.broadcast.emit("leave",{nick:t._nickname}),this.eventHandlers.leave&&this.eventHandlers.leave(t._nickname))},S.prototype.sanitiseInput=function(t){return t.trim().replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\\/g,"&quot;")},S.prototype.getIp=function(t){return t.request.connection.remoteAddress},void 0!==t&&(t.Server=S);const O=Object.create(null);O.open="0",O.close="1",O.ping="2",O.pong="3",O.message="4",O.upgrade="5",O.noop="6";const L=Object.create(null);Object.keys(O).forEach((t=>{L[O[t]]=t}));const D={type:"error",data:"parser error"},F="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),U="function"==typeof ArrayBuffer,z=t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,q=({type:t,data:e},s,r)=>F&&e instanceof Blob?s?r(e):H(e,r):U&&(e instanceof ArrayBuffer||z(e))?s?r(e):H(new Blob([e]),r):r(O[t]+(e||"")),H=(t,e)=>{const s=new FileReader;return s.onload=function(){const t=s.result.split(",")[1];e("b"+(t||""))},s.readAsDataURL(t)};function V(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let j;const Y="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",W="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let t=0;t<64;t++)W[Y.charCodeAt(t)]=t;const X="function"==typeof ArrayBuffer,G=(t,e)=>{if("string"!=typeof t)return{type:"message",data:Z(t,e)};const s=t.charAt(0);return"b"===s?{type:"message",data:K(t.substring(1),e)}:L[s]?t.length>1?{type:L[s],data:t.substring(1)}:{type:L[s]}:D},K=(t,e)=>{if(X){const s=(t=>{let e,s,r,i,n,o=.75*t.length,a=t.length,h=0;"="===t[t.length-1]&&(o--,"="===t[t.length-2]&&o--);const c=new ArrayBuffer(o),l=new Uint8Array(c);for(e=0;e<a;e+=4)s=W[t.charCodeAt(e)],r=W[t.charCodeAt(e+1)],i=W[t.charCodeAt(e+2)],n=W[t.charCodeAt(e+3)],l[h++]=s<<2|r>>4,l[h++]=(15&r)<<4|i>>2,l[h++]=(3&i)<<6|63&n;return c})(t);return Z(s,e)}return{base64:!0,data:t}},Z=(t,e)=>"blob"===e?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer,Q=String.fromCharCode(30);function J(){return new TransformStream({transform(t,e){!function(t,e){F&&t.data instanceof Blob?t.data.arrayBuffer().then(V).then(e):U&&(t.data instanceof ArrayBuffer||z(t.data))?e(V(t.data)):q(t,!1,(t=>{j||(j=new TextEncoder),e(j.encode(t))}))}(t,(s=>{const r=s.length;let i;if(r<126)i=new Uint8Array(1),new DataView(i.buffer).setUint8(0,r);else if(r<65536){i=new Uint8Array(3);const t=new DataView(i.buffer);t.setUint8(0,126),t.setUint16(1,r)}else{i=new Uint8Array(9);const t=new DataView(i.buffer);t.setUint8(0,127),t.setBigUint64(1,BigInt(r))}t.data&&"string"!=typeof t.data&&(i[0]|=128),e.enqueue(i),e.enqueue(s)}))}})}let $;function tt(t){return t.reduce(((t,e)=>t+e.length),0)}function et(t,e){if(t[0].length===e)return t.shift();const s=new Uint8Array(e);let r=0;for(let i=0;i<e;i++)s[i]=t[0][r++],r===t[0].length&&(t.shift(),r=0);return t.length&&r<t[0].length&&(t[0]=t[0].slice(r)),s}function st(t){if(t)return function(t){for(var e in st.prototype)t[e]=st.prototype[e];return t}(t)}st.prototype.on=st.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},st.prototype.once=function(t,e){function s(){this.off(t,s),e.apply(this,arguments)}return s.fn=e,this.on(t,s),this},st.prototype.off=st.prototype.removeListener=st.prototype.removeAllListeners=st.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var s,r=this._callbacks["$"+t];if(!r)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var i=0;i<r.length;i++)if((s=r[i])===e||s.fn===e){r.splice(i,1);break}return 0===r.length&&delete this._callbacks["$"+t],this},st.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),s=this._callbacks["$"+t],r=1;r<arguments.length;r++)e[r-1]=arguments[r];if(s){r=0;for(var i=(s=s.slice(0)).length;r<i;++r)s[r].apply(this,e)}return this},st.prototype.emitReserved=st.prototype.emit,st.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},st.prototype.hasListeners=function(t){return!!this.listeners(t).length};const rt="function"==typeof Promise&&"function"==typeof Promise.resolve?t=>Promise.resolve().then(t):(t,e)=>e(t,0),it="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function nt(t,...e){return e.reduce(((e,s)=>(t.hasOwnProperty(s)&&(e[s]=t[s]),e)),{})}const ot=it.setTimeout,at=it.clearTimeout;function ht(t,e){e.useNativeTimers?(t.setTimeoutFn=ot.bind(it),t.clearTimeoutFn=at.bind(it)):(t.setTimeoutFn=it.setTimeout.bind(it),t.clearTimeoutFn=it.clearTimeout.bind(it))}function ct(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}class lt extends Error{constructor(t,e,s){super(t),this.description=e,this.context=s,this.type="TransportError"}}class ut extends st{constructor(t){super(),this.writable=!1,ht(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,s){return super.emitReserved("error",new lt(t,e,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(t){"open"===this.readyState&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=G(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return-1===t.indexOf(":")?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(t){const e=function(t){let e="";for(let s in t)t.hasOwnProperty(s)&&(e.length&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));return e}(t);return e.length?"?"+e:""}}class dt extends ut{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this._polling||!this.writable){let t=0;this._polling&&(t++,this.once("pollComplete",(function(){--t||e()}))),this.writable||(t++,this.once("drain",(function(){--t||e()})))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){((t,e)=>{const s=t.split(Q),r=[];for(let i=0;i<s.length;i++){const t=G(s[i],e);if(r.push(t),"error"===t.type)break}return r})(t,this.socket.binaryType).forEach((t=>{if("opening"===this.readyState&&"open"===t.type&&this.onOpen(),"close"===t.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(t)})),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this._poll())}doClose(){const t=()=>{this.write([{type:"close"}])};"open"===this.readyState?t():this.once("open",t)}write(t){this.writable=!1,((t,e)=>{const s=t.length,r=new Array(s);let i=0;t.forEach(((t,n)=>{q(t,!1,(t=>{r[n]=t,++i===s&&e(r.join(Q))}))}))})(t,(t=>{this.doWrite(t,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const t=this.opts.secure?"https":"http",e=this.query||{};return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=ct()),this.supportsBinary||e.sid||(e.b64=1),this.createUri(t,e)}}let pt=!1;try{pt="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(he){}const ft=pt;function yt(){}class gt extends dt{constructor(t){if(super(t),"undefined"!=typeof location){const e="https:"===location.protocol;let s=location.port;s||(s=e?"443":"80"),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||s!==t.port}}doWrite(t,e){const s=this.request({method:"POST",data:t});s.on("success",e),s.on("error",((t,e)=>{this.onError("xhr post error",t,e)}))}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",((t,e)=>{this.onError("xhr poll error",t,e)})),this.pollXhr=t}}class mt extends st{constructor(t,e,s){super(),this.createRequest=t,ht(this,s),this._opts=s,this._method=s.method||"GET",this._uri=e,this._data=void 0!==s.data?s.data:null,this._create()}_create(){var t;const e=nt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(e);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let t in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(t)&&s.setRequestHeader(t,this._opts.extraHeaders[t])}}catch(r){}if("POST"===this._method)try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(r){}try{s.setRequestHeader("Accept","*/*")}catch(r){}null===(t=this._opts.cookieJar)||void 0===t||t.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var t;3===s.readyState&&(null===(t=this._opts.cookieJar)||void 0===t||t.parseCookies(s.getResponseHeader("set-cookie"))),4===s.readyState&&(200===s.status||1223===s.status?this._onLoad():this.setTimeoutFn((()=>{this._onError("number"==typeof s.status?s.status:0)}),0))},s.send(this._data)}catch(r){return void this.setTimeoutFn((()=>{this._onError(r)}),0)}"undefined"!=typeof document&&(this._index=mt.requestsCount++,mt.requests[this._index]=this)}_onError(t){this.emitReserved("error",t,this._xhr),this._cleanup(!0)}_cleanup(t){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=yt,t)try{this._xhr.abort()}catch(e){}"undefined"!=typeof document&&delete mt.requests[this._index],this._xhr=null}}_onLoad(){const t=this._xhr.responseText;null!==t&&(this.emitReserved("data",t),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}function At(){for(let t in mt.requests)mt.requests.hasOwnProperty(t)&&mt.requests[t].abort()}mt.requestsCount=0,mt.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",At):"function"==typeof addEventListener&&addEventListener("onpagehide"in it?"pagehide":"unload",At,!1));const bt=function(){const t=xt({xdomain:!1});return t&&null!==t.responseType}();function xt(t){const e=t.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!e||ft))return new XMLHttpRequest}catch(s){}if(!e)try{return new(it[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(s){}}const wt="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class vt extends ut{get name(){return"websocket"}doOpen(){const t=this.uri(),e=this.opts.protocols,s=wt?{}:nt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,s)}catch(he){return this.emitReserved("error",he)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],r=e===t.length-1;q(s,this.supportsBinary,(t=>{try{this.doWrite(s,t)}catch(e){}r&&rt((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=ct()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}}const Mt=it.WebSocket||it.MozWebSocket,kt={websocket:class extends vt{createSocket(t,e,s){return wt?new Mt(t,e,s):e?new Mt(t,e):new Mt(t)}doWrite(t,e){this.ws.send(e)}},webtransport:class extends ut{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(he){return this.emitReserved("error",he)}this._transport.closed.then((()=>{this.onClose()})).catch((t=>{this.onError("webtransport error",t)})),this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((t=>{const e=function(t,e){$||($=new TextDecoder);const s=[];let r=0,i=-1,n=!1;return new TransformStream({transform(o,a){for(s.push(o);;){if(0===r){if(tt(s)<1)break;const t=et(s,1);n=!(128&~t[0]),i=127&t[0],r=i<126?3:126===i?1:2}else if(1===r){if(tt(s)<2)break;const t=et(s,2);i=new DataView(t.buffer,t.byteOffset,t.length).getUint16(0),r=3}else if(2===r){if(tt(s)<8)break;const t=et(s,8),e=new DataView(t.buffer,t.byteOffset,t.length),n=e.getUint32(0);if(n>Math.pow(2,21)-1){a.enqueue(D);break}i=n*Math.pow(2,32)+e.getUint32(4),r=3}else{if(tt(s)<i)break;const t=et(s,i);a.enqueue(G(n?t:$.decode(t),e)),r=0}if(0===i||i>t){a.enqueue(D);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=t.readable.pipeThrough(e).getReader(),r=J();r.readable.pipeTo(t.writable),this._writer=r.writable.getWriter();const i=()=>{s.read().then((({done:t,value:e})=>{t||(this.onPacket(e),i())})).catch((t=>{}))};i();const n={type:"open"};this.query.sid&&(n.data=`{"sid":"${this.query.sid}"}`),this._writer.write(n).then((()=>this.onOpen()))}))}))}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],r=e===t.length-1;this._writer.write(s).then((()=>{r&&rt((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var t;null===(t=this._transport)||void 0===t||t.close()}},polling:class extends gt{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=bt&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new mt(xt,this.uri(),t)}}},Tt=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Et=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Rt(t){if(t.length>8e3)throw"URI too long";const e=t,s=t.indexOf("["),r=t.indexOf("]");-1!=s&&-1!=r&&(t=t.substring(0,s)+t.substring(s,r).replace(/:/g,";")+t.substring(r,t.length));let i=Tt.exec(t||""),n={},o=14;for(;o--;)n[Et[o]]=i[o]||"";return-1!=s&&-1!=r&&(n.source=e,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=function(t,e){const s=/\/{2,9}/g,r=e.replace(s,"/").split("/");return"/"!=e.slice(0,1)&&0!==e.length||r.splice(0,1),"/"==e.slice(-1)&&r.splice(r.length-1,1),r}(0,n.path),n.queryKey=function(t,e){const s={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,e,r){e&&(s[e]=r)})),s}(0,n.query),n}const _t="function"==typeof addEventListener&&"function"==typeof removeEventListener,Bt=[];_t&&addEventListener("offline",(()=>{Bt.forEach((t=>t()))}),!1);class Pt extends st{constructor(t,e){if(super(),this.binaryType="arraybuffer",this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,t&&"object"==typeof t&&(e=t,t=null),t){const s=Rt(t);e.hostname=s.host,e.secure="https"===s.protocol||"wss"===s.protocol,e.port=s.port,s.query&&(e.query=s.query)}else e.host&&(e.hostname=Rt(e.host).host);ht(this,e),this.secure=null!=e.secure?e.secure:"undefined"!=typeof location&&"https:"===location.protocol,e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=e.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach((t=>{const e=t.prototype.name;this.transports.push(e),this._transportsByName[e]=t})),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=function(t){let e={},s=t.split("&");for(let r=0,i=s.length;r<i;r++){let t=s[r].split("=");e[decodeURIComponent(t[0])]=decodeURIComponent(t[1])}return e}(this.opts.query)),_t&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},Bt.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=4,e.transport=t,this.id&&(e.sid=this.id);const s=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](s)}_open(){if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);const t=this.opts.rememberUpgrade&&Pt.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open(),this.setTransport(e)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(t=>this._onClose("transport close",t)))}onOpen(){this.readyState="open",Pt.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data,this._onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data)}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this._pingInterval=t.pingInterval,this._pingTimeout=t.pingTimeout,this._maxPayload=t.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t,this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),t),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t),this._prevBufferLen=t.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let s=0;s<this.writeBuffer.length;s++){const r=this.writeBuffer[s].data;if(r&&(t+="string"==typeof(e=r)?function(t){let e=0,s=0;for(let r=0,i=t.length;r<i;r++)e=t.charCodeAt(r),e<128?s+=1:e<2048?s+=2:e<55296||e>=57344?s+=3:(r++,s+=4);return s}(e):Math.ceil(1.33*(e.byteLength||e.size))),s>0&&t>this._maxPayload)return this.writeBuffer.slice(0,s);t+=2}var e;return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const t=Date.now()>this._pingTimeoutTime;return t&&(this._pingTimeoutTime=0,rt((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)),t}write(t,e,s){return this._sendPacket("message",t,e,s),this}send(t,e,s){return this._sendPacket("message",t,e,s),this}_sendPacket(t,e,s,r){if("function"==typeof e&&(r=e,e=void 0),"function"==typeof s&&(r=s,s=null),"closing"===this.readyState||"closed"===this.readyState)return;(s=s||{}).compress=!1!==s.compress;const i={type:t,data:e,options:s};this.emitReserved("packetCreate",i),this.writeBuffer.push(i),r&&this.once("flush",r),this.flush()}close(){const t=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},s=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?s():t()})):this.upgrading?s():t()),this}_onError(t){if(Pt.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return this.transports.shift(),this._open();this.emitReserved("error",t),this._onClose("transport error",t)}_onClose(t,e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),_t&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const t=Bt.indexOf(this._offlineEventListener);-1!==t&&Bt.splice(t,1)}this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this._prevBufferLen=0}}}Pt.protocol=4;class Ct extends Pt{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade)for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}_probe(t){let e=this.createTransport(t),s=!1;Pt.priorWebsocketSuccess=!1;const r=()=>{s||(e.send([{type:"ping",data:"probe"}]),e.once("packet",(t=>{if(!s)if("pong"===t.type&&"probe"===t.data){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;Pt.priorWebsocketSuccess="websocket"===e.name,this.transport.pause((()=>{s||"closed"!==this.readyState&&(c(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())}))}else{const t=new Error("probe error");t.transport=e.name,this.emitReserved("upgradeError",t)}})))};function i(){s||(s=!0,c(),e.close(),e=null)}const n=t=>{const s=new Error("probe error: "+t);s.transport=e.name,i(),this.emitReserved("upgradeError",s)};function o(){n("transport closed")}function a(){n("socket closed")}function h(t){e&&t.name!==e.name&&i()}const c=()=>{e.removeListener("open",r),e.removeListener("error",n),e.removeListener("close",o),this.off("close",a),this.off("upgrading",h)};e.once("open",r),e.once("error",n),e.once("close",o),this.once("close",a),this.once("upgrading",h),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==t?this.setTimeoutFn((()=>{s||e.open()}),200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let s=0;s<t.length;s++)~this.transports.indexOf(t[s])&&e.push(t[s]);return e}}let It=class extends Ct{constructor(t,e={}){const s="object"==typeof t?t:e;(!s.transports||s.transports&&"string"==typeof s.transports[0])&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map((t=>kt[t])).filter((t=>!!t))),super(t,s)}};const St="function"==typeof ArrayBuffer,Nt=Object.prototype.toString,Ot="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Nt.call(Blob),Lt="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===Nt.call(File);function Dt(t){return St&&(t instanceof ArrayBuffer||(t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer)(t))||Ot&&t instanceof Blob||Lt&&t instanceof File}function Ft(t,e){if(!t||"object"!=typeof t)return!1;if(Array.isArray(t)){for(let e=0,s=t.length;e<s;e++)if(Ft(t[e]))return!0;return!1}if(Dt(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return Ft(t.toJSON(),!0);for(const s in t)if(Object.prototype.hasOwnProperty.call(t,s)&&Ft(t[s]))return!0;return!1}function Ut(t){const e=[],s=t.data,r=t;return r.data=zt(s,e),r.attachments=e.length,{packet:r,buffers:e}}function zt(t,e){if(!t)return t;if(Dt(t)){const s={_placeholder:!0,num:e.length};return e.push(t),s}if(Array.isArray(t)){const s=new Array(t.length);for(let r=0;r<t.length;r++)s[r]=zt(t[r],e);return s}if("object"==typeof t&&!(t instanceof Date)){const s={};for(const r in t)Object.prototype.hasOwnProperty.call(t,r)&&(s[r]=zt(t[r],e));return s}return t}function qt(t,e){return t.data=Ht(t.data,e),delete t.attachments,t}function Ht(t,e){if(!t)return t;if(t&&!0===t._placeholder){if("number"==typeof t.num&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}if(Array.isArray(t))for(let s=0;s<t.length;s++)t[s]=Ht(t[s],e);else if("object"==typeof t)for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(t[s]=Ht(t[s],e));return t}const Vt=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"];var jt;function Yt(t){return"[object Object]"===Object.prototype.toString.call(t)}!function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"}(jt||(jt={}));class Wt extends st{constructor(t){super(),this.reviver=t}add(t){let e;if("string"==typeof t){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t);const s=e.type===jt.BINARY_EVENT;s||e.type===jt.BINARY_ACK?(e.type=s?jt.EVENT:jt.ACK,this.reconstructor=new Xt(e),0===e.attachments&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else{if(!Dt(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e))}}decodeString(t){let e=0;const s={type:Number(t.charAt(0))};if(void 0===jt[s.type])throw new Error("unknown packet type "+s.type);if(s.type===jt.BINARY_EVENT||s.type===jt.BINARY_ACK){const r=e+1;for(;"-"!==t.charAt(++e)&&e!=t.length;);const i=t.substring(r,e);if(i!=Number(i)||"-"!==t.charAt(e))throw new Error("Illegal attachments");s.attachments=Number(i)}if("/"===t.charAt(e+1)){const r=e+1;for(;++e&&","!==t.charAt(e)&&e!==t.length;);s.nsp=t.substring(r,e)}else s.nsp="/";const r=t.charAt(e+1);if(""!==r&&Number(r)==r){const r=e+1;for(;++e;){const s=t.charAt(e);if(null==s||Number(s)!=s){--e;break}if(e===t.length)break}s.id=Number(t.substring(r,e+1))}if(t.charAt(++e)){const r=this.tryParse(t.substr(e));if(!Wt.isPayloadValid(s.type,r))throw new Error("invalid payload");s.data=r}return s}tryParse(t){try{return JSON.parse(t,this.reviver)}catch(e){return!1}}static isPayloadValid(t,e){switch(t){case jt.CONNECT:return Yt(e);case jt.DISCONNECT:return void 0===e;case jt.CONNECT_ERROR:return"string"==typeof e||Yt(e);case jt.EVENT:case jt.BINARY_EVENT:return Array.isArray(e)&&("number"==typeof e[0]||"string"==typeof e[0]&&-1===Vt.indexOf(e[0]));case jt.ACK:case jt.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class Xt{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const t=qt(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}const Gt=Object.freeze(Object.defineProperty({__proto__:null,Decoder:Wt,Encoder:class{constructor(t){this.replacer=t}encode(t){return t.type!==jt.EVENT&&t.type!==jt.ACK||!Ft(t)?[this.encodeAsString(t)]:this.encodeAsBinary({type:t.type===jt.EVENT?jt.BINARY_EVENT:jt.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id})}encodeAsString(t){let e=""+t.type;return t.type!==jt.BINARY_EVENT&&t.type!==jt.BINARY_ACK||(e+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(e+=t.nsp+","),null!=t.id&&(e+=t.id),null!=t.data&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){const e=Ut(t),s=this.encodeAsString(e.packet),r=e.buffers;return r.unshift(s),r}},get PacketType(){return jt},protocol:5},Symbol.toStringTag,{value:"Module"}));function Kt(t,e,s){return t.on(e,s),function(){t.off(e,s)}}const Zt=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Qt extends st{constructor(t,e,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[Kt(t,"open",this.onopen.bind(this)),Kt(t,"packet",this.onpacket.bind(this)),Kt(t,"error",this.onerror.bind(this)),Kt(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var s,r,i;if(Zt.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const n={type:jt.EVENT,data:e,options:{}};if(n.options.compress=!1!==this.flags.compress,"function"==typeof e[e.length-1]){const t=this.ids++,s=e.pop();this._registerAckCallback(t,s),n.id=t}const o=null===(r=null===(s=this.io.engine)||void 0===s?void 0:s.transport)||void 0===r?void 0:r.writable,a=this.connected&&!(null===(i=this.io.engine)||void 0===i?void 0:i._hasPingExpired());return this.flags.volatile&&!o||(a?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(t,e){var s;const r=null!==(s=this.flags.timeout)&&void 0!==s?s:this._opts.ackTimeout;if(void 0===r)return void(this.acks[t]=e);const i=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let e=0;e<this.sendBuffer.length;e++)this.sendBuffer[e].id===t&&this.sendBuffer.splice(e,1);e.call(this,new Error("operation has timed out"))}),r),n=(...t)=>{this.io.clearTimeoutFn(i),e.apply(this,t)};n.withError=!0,this.acks[t]=n}emitWithAck(t,...e){return new Promise(((s,r)=>{const i=(t,e)=>t?r(t):s(e);i.withError=!0,e.push(i),this.emit(t,...e)}))}_addToQueue(t){let e;"function"==typeof t[t.length-1]&&(e=t.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push(((t,...r)=>{if(s===this._queue[0])return null!==t?s.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(t)):(this._queue.shift(),e&&e(null,...r)),s.pending=!1,this._drainQueue()})),this._queue.push(s),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||0===this._queue.length)return;const e=this._queue[0];e.pending&&!t||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){"function"==typeof this.auth?this.auth((t=>{this._sendConnectPacket(t)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:jt.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((t=>{if(!this.sendBuffer.some((e=>String(e.id)===t))){const e=this.acks[t];delete this.acks[t],e.withError&&e.call(this,new Error("socket has been disconnected"))}}))}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case jt.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case jt.EVENT:case jt.BINARY_EVENT:this.onevent(t);break;case jt.ACK:case jt.BINARY_ACK:this.onack(t);break;case jt.DISCONNECT:this.ondisconnect();break;case jt.CONNECT_ERROR:this.destroy();const e=new Error(t.data.message);e.data=t.data.data,this.emitReserved("connect_error",e)}}onevent(t){const e=t.data||[];null!=t.id&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const s of e)s.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&"string"==typeof t[t.length-1]&&(this._lastOffset=t[t.length-1])}ack(t){const e=this;let s=!1;return function(...r){s||(s=!0,e.packet({type:jt.ACK,id:t,data:r}))}}onack(t){const e=this.acks[t.id];"function"==typeof e&&(delete this.acks[t.id],e.withError&&t.data.unshift(null),e.apply(this,t.data))}onconnect(t,e){this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t))),this.receiveBuffer=[],this.sendBuffer.forEach((t=>{this.notifyOutgoingListeners(t),this.packet(t)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((t=>t())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:jt.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const s of e)s.apply(this,t.data)}}}function Jt(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}Jt.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),s=Math.floor(e*this.jitter*t);t=1&Math.floor(10*e)?t+s:t-s}return 0|Math.min(t,this.max)},Jt.prototype.reset=function(){this.attempts=0},Jt.prototype.setMin=function(t){this.ms=t},Jt.prototype.setMax=function(t){this.max=t},Jt.prototype.setJitter=function(t){this.jitter=t};class $t extends st{constructor(t,e){var s;super(),this.nsps={},this.subs=[],t&&"object"==typeof t&&(e=t,t=void 0),(e=e||{}).path=e.path||"/socket.io",this.opts=e,ht(this,e),this.reconnection(!1!==e.reconnection),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(s=e.randomizationFactor)&&void 0!==s?s:.5),this.backoff=new Jt({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this._readyState="closed",this.uri=t;const r=e.parser||Gt;this.encoder=new r.Encoder,this.decoder=new r.Decoder,this._autoConnect=!1!==e.autoConnect,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return void 0===t?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return void 0===t?this._reconnectionDelay:(this._reconnectionDelay=t,null===(e=this.backoff)||void 0===e||e.setMin(t),this)}randomizationFactor(t){var e;return void 0===t?this._randomizationFactor:(this._randomizationFactor=t,null===(e=this.backoff)||void 0===e||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return void 0===t?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,null===(e=this.backoff)||void 0===e||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new It(this.uri,this.opts);const e=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const r=Kt(e,"open",(function(){s.onopen(),t&&t()})),i=e=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",e),t?t(e):this.maybeReconnectOnOpen()},n=Kt(e,"error",i);if(!1!==this._timeout){const t=this._timeout,s=this.setTimeoutFn((()=>{r(),i(new Error("timeout")),e.close()}),t);this.opts.autoUnref&&s.unref(),this.subs.push((()=>{this.clearTimeoutFn(s)}))}return this.subs.push(r),this.subs.push(n),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push(Kt(t,"ping",this.onping.bind(this)),Kt(t,"data",this.ondata.bind(this)),Kt(t,"error",this.onerror.bind(this)),Kt(t,"close",this.onclose.bind(this)),Kt(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(e){this.onclose("parse error",e)}}ondecoded(t){rt((()=>{this.emitReserved("packet",t)}),this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let s=this.nsps[t];return s?this._autoConnect&&!s.active&&s.connect():(s=new Qt(this,t,e),this.nsps[t]=s),s}_destroy(t){const e=Object.keys(this.nsps);for(const s of e)if(this.nsps[s].active)return;this._close()}_packet(t){const e=this.encoder.encode(t);for(let s=0;s<e.length;s++)this.engine.write(e[s],t.options)}cleanup(){this.subs.forEach((t=>t())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var s;this.cleanup(),null===(s=this.engine)||void 0===s||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn((()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((e=>{e?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",e)):t.onreconnect()})))}),e);this.opts.autoUnref&&s.unref(),this.subs.push((()=>{this.clearTimeoutFn(s)}))}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const te={};function ee(t,e){"object"==typeof t&&(e=t,t=void 0);const s=function(t,e="",s){let r=t;s=s||"undefined"!=typeof location&&location,null==t&&(t=s.protocol+"//"+s.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?s.protocol+t:s.host+t),/^(https?|wss?):\/\//.test(t)||(t=void 0!==s?s.protocol+"//"+t:"https://"+t),r=Rt(t)),r.port||(/^(http|ws)$/.test(r.protocol)?r.port="80":/^(http|ws)s$/.test(r.protocol)&&(r.port="443")),r.path=r.path||"/";const i=-1!==r.host.indexOf(":")?"["+r.host+"]":r.host;return r.id=r.protocol+"://"+i+":"+r.port+e,r.href=r.protocol+"://"+i+(s&&s.port===r.port?"":":"+r.port),r}(t,(e=e||{}).path||"/socket.io"),r=s.source,i=s.id,n=s.path,o=te[i]&&n in te[i].nsps;let a;return e.forceNew||e["force new connection"]||!1===e.multiplex||o?a=new $t(r,e):(te[i]||(te[i]=new $t(r,e)),a=te[i]),s.query&&!e.query&&(e.query=s.queryKey),a.socket(s.path,e)}let se,re,ie;Object.assign(ee,{Manager:$t,Socket:Qt,io:ee,connect:ee}),window.global=window;const ne={nickname:document.getElementById("nickname"),joinInfo:document.getElementById("joininfo"),joinInfoText:document.getElementById("joininfo_text"),renderSurface:document.getElementById("renderSurface"),materialSelector:document.getElementById("materialSelector"),chatbox:document.getElementById("chatbox"),chatboxEntry:document.getElementById("chatbox_entry"),chatboxText:document.getElementById("chatbox_text")};for(const t in ne)null===ne[t]&&console.error(`Element with id '${t}' not found.`);ne.nickname&&(ne.nickname.style.color="white",ne.nickname.style.backgroundColor="black",ne.nickname.onkeypress=t=>window.onNicknameEnter(ne.nickname,t)),window.onNicknameEnter=(t,e)=>{if(!t||!t.value)return;const s=t.value.trim();13===e.keyCode&&0!==s.length&&(t.blur(),ae(s))},window.onChatEnter=(t,e)=>{const s=t.value.trim();13===e.keyCode&&(t.blur(),ne.chatbox.style.height=null,0!==s.length&&(se.sendMessage(s),t.value=""))};const oe=()=>{const t=new C;t.setWorld(re),t.setClient(se),t.setInputCanvas("renderSurface"),t.setMaterialSelector("materialSelector"),t.on("openChat",(()=>{ne.chatboxEntry.focus(),ne.chatbox.style.height=ie.gl.viewportHeight-145+"px"})),ne.joinInfo.style.visibility="hidden",ne.renderSurface.style.visibility=null,ne.materialSelector.style.display=null,ne.chatbox.style.visibility=null,ne.chatboxEntry.style.visibility=null;let e=Date.now()/1e3;const s=setInterval((()=>{const s=Date.now()/1e3;t.update(),s-e>.033&&(se.updatePlayer(t),e=s),ie.buildChunks(5),t.getEyePos()&&ie.setCamera(t.getEyePos().toArray(),t.angles),ie.draw()}),16);se.on("disconnect",(t=>{clearInterval(s),t||(ne.joinInfo.style.visibility=null,ne.renderSurface.style.visibility="hidden",ne.materialSelector.style.display="none",ne.chatbox.style.visibility="hidden",ne.chatboxEntry.style.visibility="hidden",ne.joinInfoText.innerHTML='<span style="color: #f00; text-shadow: #a00 2px 2px 0px">Connection Problem:</span> Lost connection to server!')}))},ae=t=>{(t=>{ne.nickname.style.visibility="hidden",ne.joinInfo.style.visibility=null,ne.joinInfoText.innerHTML="Connecting to server on port 3000...",se=new I(ee),se.connect("https://scaling-funicular-p4qvr9vp44fq6j-3000.app.github.dev/",t),se.on("connect",(()=>{ne.joinInfoText.innerHTML="Receiving world...",re=new T(100,100,50),console.log("World setup complete"),ie=new E("renderSurface"),ie.setWorld(re,8);const t=ie.gl;ie.setPerspective(60*Math.PI/180,t.viewportWidth/t.viewportHeight,.01,200),console.log("Renderer setup complete"),ie.buildChunks(999),console.log("Chunks built"),ne.joinInfoText.innerHTML="Spawning...",oe()})),se.on("connect_error",(t=>{ne.joinInfoText.innerHTML=`<span style="color: #f00; text-shadow: #a00 2px 2px 0px">Connection Error:</span> ${t.message}`})),se.on("world",(t=>{console.log("World data received:",t),ne.joinInfoText.innerHTML="Building chunks...",re=new T(t.sx,t.sy,t.sz),re.createFromString(t.blocks),console.log("World setup complete"),ie=new E("renderSurface"),ie.setWorld(re,8);const e=ie.gl;ie.setPerspective(60*Math.PI/180,e.viewportWidth/e.viewportHeight,.01,200),console.log("Renderer setup complete"),ie.buildChunks(999),console.log("Chunks built"),ne.joinInfoText.innerHTML="Spawning...",oe()})),se.on("spawn",(()=>{oe()})),se.on("chat",((t,e)=>{ne.chatboxText.innerHTML+=`&lt;<span style="color: #0a0">${t}</span>&gt; ${e}<br />`})),se.on("message",(t=>{ne.chatboxText.innerHTML+=`<span style="color: #ff8">${t}</span><br />`})),se.on("kick",(t=>{ne.joinInfo.style.visibility=null,ne.renderSurface.style.visibility="hidden",ne.materialSelector.style.display="none",ne.chatbox.style.visibility="hidden",ne.chatboxEntry.style.visibility="hidden",ne.joinInfoText.innerHTML=`<span style="color: #f00; text-shadow: #a00 2px 2px 0px">Kicked:</span> ${t}`}))})(t)}}}}));
